USE [TESTES]
GO

/****** Object:  View [dbo].[W_PRODUCAO_TAREFAS_NECESSIDADE]    Script Date: 12/02/2015 11:12:37 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


create VIEW [dbo].[W_PRODUCAO_TAREFAS_NECESSIDADE]
AS  
SELECT  distinct A.PRODUTO,  
 A.COR_PRODUTO,  
 SEQUENCIA_PRODUTIVA = ISNULL(B.SEQUENCIA_PRODUTIVA,D.SEQUENCIA_PRODUTIVA),  
 FASE_PRODUCAO = ISNULL(B.FASE_PRODUCAO,D.FASE_PRODUCAO),  
 QTDE_FASE = ISNULL(B.QTDE_FASE,0),   
 QTDE_NESC =  A.QTDE ,  
 F1=ISNULL(B.F1,0),F2=ISNULL(B.F2,0),F3=ISNULL(B.F3,0),F4=ISNULL(B.F4,0),F5=ISNULL(B.F5,0),F6=ISNULL(B.F6,0),F7=ISNULL(B.F7,0),F8=ISNULL(B.F8,0),  
 F9=ISNULL(B.F9,0),F10=ISNULL(B.F10,0),F11=ISNULL(B.F11,0),F12=ISNULL(B.F12,0),F13=ISNULL(B.F13,0),F14=ISNULL(B.F14,0),F15=ISNULL(B.F15,0),F16=ISNULL(B.F16,0),  
 F17=ISNULL(B.F17,0),F18=ISNULL(B.F18,0),F19=ISNULL(B.F19,0),F20=ISNULL(B.F20,0),F21=ISNULL(B.F21,0),F22=ISNULL(B.F22,0),F23=ISNULL(B.F23,0),F24=ISNULL(B.F24,0),  
 F25=ISNULL(B.F25,0),F26=ISNULL(B.F26,0),F27=ISNULL(B.F27,0),F28=ISNULL(B.F28,0),F29=ISNULL(B.F29,0),F30=ISNULL(B.F30,0),F31=ISNULL(B.F31,0),F32=ISNULL(B.F32,0),  
 F33=ISNULL(B.F33,0),F34=ISNULL(B.F34,0),F35=ISNULL(B.F35,0),F36=ISNULL(B.F36,0),F37=ISNULL(B.F37,0),F38=ISNULL(B.F38,0),F39=ISNULL(B.F39,0),F40=ISNULL(B.F40,0),  
 F41=ISNULL(B.F41,0),F42=ISNULL(B.F42,0),F43=ISNULL(B.F43,0),F44=ISNULL(B.F44,0),F45=ISNULL(B.F45,0),F46=ISNULL(B.F46,0),F47=ISNULL(B.F47,0),F48=ISNULL(B.F48,0),  
 N1=A.ES1,N2=A.ES2,N3=A.ES3,N4=A.ES4,N5=A.ES5,N6=A.ES6,N7=A.ES7,N8=A.ES8,N9=A.ES9,N10=A.ES10,N11=A.ES11,N12=A.ES12,N13=A.ES13,N14=A.ES14,N15=A.ES15,N16=A.ES16,  
 N17=A.ES17,N18=A.ES18,N19=A.ES19,N20=A.ES20,N21=A.ES21,N22=A.ES22,N23=A.ES23,N24=A.ES24,N25=A.ES25,N26=A.ES26,N27=A.ES27,N28=A.ES28,N29=A.ES29,N30=A.ES30,N31=A.ES31,N32=A.ES32,  
 N33=A.ES33,N34=A.ES34,N35=A.ES35,N36=A.ES36,N37=A.ES37,N38=A.ES38,N39=A.ES39,N40=A.ES40,N41=A.ES41,N42=A.ES42,N43=A.ES43,N44=A.ES44,N45=A.ES45,N46=A.ES46,N47=A.ES47,N48=A.ES48  
FROM  W_NECESSIDADE_ESTOQUE_VENDAS A  
  LEFT JOIN   
    (SELECT A.PRODUTO,A.COR_PRODUTO,B.SEQUENCIA_PRODUTIVA,B.FASE_PRODUCAO, ISNULL(SUM(QTDE_S),0) AS QTDE_FASE,  
     F1=SUM(S1),F2=SUM(S2),F3=SUM(S3),F4=SUM(S4),F5=SUM(S5),F6=SUM(S6),F7=SUM(S7),F8=SUM(S8),F9=SUM(S9),F10=SUM(S10),F11=SUM(S11),F12=SUM(S12),  
     F13=SUM(S13),F14=SUM(S14),F15=SUM(S15),F16=SUM(S16),F17=SUM(S17),F18=SUM(S18),F19=SUM(S19),F20=SUM(S20),F21=SUM(S21),F22=SUM(S22),F23=SUM(S23),F24=SUM(S24),  
     F25=SUM(S25),F26=SUM(S26),F27=SUM(S27),F28=SUM(S28),F29=SUM(S29),F30=SUM(S30),F31=SUM(S31),F32=SUM(S32),F33=SUM(S33),F34=SUM(S34),F35=SUM(S35),F36=SUM(S36),  
     F37=SUM(S37),F38=SUM(S38),F39=SUM(S39),F40=SUM(S40),F41=SUM(S41),F42=SUM(S42),F43=SUM(S43),F44=SUM(S44),F45=SUM(S45),F46=SUM(S46),F47=SUM(S47),F48=SUM(S48)  
     FROM PRODUCAO_ORDEM_COR A   
     JOIN PRODUCAO_TAREFAS B ON A.ORDEM_PRODUCAO=B.ORDEM_PRODUCAO  
     LEFT JOIN PRODUCAO_TAREFAS_SALDO C ON C.TAREFA=B.TAREFA AND C.ORDEM_PRODUCAO=B.ORDEM_PRODUCAO AND C.PRODUTO=A.PRODUTO AND C.COR_PRODUTO=A.COR_PRODUTO  
                                        LEFT JOIN PRODUCAO_ORDEM D ON A.ORDEM_PRODUCAO = D.ORDEM_PRODUCAO  
     WHERE B.SETOR_PARALELO_NUMERO <= 1   
--                                       AND D.ORDEM_PRODUCAO >= ISNULL((SELECT VALOR_ATUAL FROM PARAMETROS WHERE PARAMETRO ='OP_INICIAL'), '0' )   
--                                       AND D.ORDEM_PRODUCAO <= ISNULL((SELECT VALOR_ATUAL FROM PARAMETROS WHERE PARAMETRO ='OP_FINAL'), '99999999' )    
--                                       AND D.PROGRAMACAO LIKE  ISNULL((SELECT VALOR_ATUAL FROM PARAMETROS WHERE PARAMETRO ='PROGRAMACAO'), '%' )  
--                                       AND D.TIPO_ORDEM_PRODUCAO LIKE  ISNULL((SELECT VALOR_ATUAL FROM PARAMETROS WHERE PARAMETRO ='TIPO_OP'), '%' )  
     GROUP BY A.PRODUTO,A.COR_PRODUTO,B.SEQUENCIA_PRODUTIVA,B.FASE_PRODUCAO) B  
   ON A.PRODUTO=B.PRODUTO AND A.COR_PRODUTO=B.COR_PRODUTO  
  LEFT JOIN  
    (SELECT DISTINCT C.PRODUTO,C.COR_PRODUTO,A.FASE_PRODUCAO,A.SEQUENCIA_PRODUTIVA  
     FROM PRODUTO_OPERACOES_ROTAS A   
     JOIN PRODUTOS B ON A.TABELA_OPERACOES=B.TABELA_OPERACOES   
     JOIN PRODUTO_CORES C ON C.PRODUTO=B.PRODUTO  
     LEFT JOIN (PRODUCAO_ORDEM_COR D   
         JOIN PRODUCAO_TAREFAS E ON D.ORDEM_PRODUCAO=E.ORDEM_PRODUCAO)  
      ON D.PRODUTO=C.PRODUTO AND D.COR_PRODUTO=C.COR_PRODUTO  
     WHERE D.PRODUTO IS NULL)D   
   ON D.PRODUTO=A.PRODUTO AND D.COR_PRODUTO=A.COR_PRODUTO  
WHERE B.FASE_PRODUCAO IS NOT NULL OR D.FASE_PRODUCAO IS NOT NULL  
  

GO


