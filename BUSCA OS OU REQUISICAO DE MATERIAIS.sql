-- ldr <> oficina
exec sp_executesql N'
/* lx100107spk  CursorAdapter: cur_v_faturamento_05_producao_os(Alias: v_faturamento_05_producao_os)  */
SELECT PRODUCAO_ORDEM_SERVICO.ORDEM_SERVICO,  PRODUCAO_ORDEM_SERVICO.RECURSO_PRODUTIVO,  PRODUCAO_ORDEM_SERVICO.FASE_PRODUCAO, PRODUCAO_ORDEM_SERVICO.DATA,  PRODUCAO_ORDEM_SERVICO.SETOR_PRODUCAO,  PRODUCAO_ORDEM_SERVICO.CONFERIDO_POR,  PRODUCAO_ORDEM_SERVICO.OBSERVACAO, PRODUCAO_FASE.DESC_FASE_PRODUCAO,  PRODUCAO_SETOR.DESC_SETOR_PRODUCAO, PRODUCAO_RECURSOS.TIPO_RECURSO,  PRODUCAO_RECURSOS.DESC_RECURSO, PRODUCAO_RECURSOS.RECURSO_PROPRIO,  PRODUCAO_ORDEM_SERVICO.ORDEM_SERVICO_PARALELA,  PRODUCAO_ORDEM_SERVICO.FILIAL, PRODUCAO_ORDEM_SERVICO.NF_SAIDA,  PRODUCAO_ORDEM_SERVICO.SERIE_NF, PRODUCAO_ORDEM_SERVICO.NF_ENTRADA,  PRODUCAO_ORDEM_SERVICO.INDICADOR_TIPO_MOV,  PRODUCAO_ORDEM_SERVICO.SEGUNDA_QUALIDADE, SPACE(5) AS RECURSO_ORIGEM,  SPACE(40) AS DESC_REC_ORIGEM, PRODUCAO_ORDEM_SERVICO.ACERTO_ENTRADA,  FILIAIS.EMPRESA FROM DBO.PRODUCAO_ORDEM_SERVICO PRODUCAO_ORDEM_SERVICO,  DBO.PRODUCAO_FASE PRODUCAO_FASE, DBO.PRODUCAO_SETOR PRODUCAO_SETOR,  DBO.PRODUCAO_RECURSOS PRODUCAO_RECURSOS, DBO.FILIAIS FILIAIS WHERE  producao_recursos.nome_clifor = @P1  and (producao_ordem_servico.serie_nf is null or producao_ordem_servico.serie_nf = '''')  and (producao_ordem_servico.nf_saida is null or producao_ordem_servico.nf_saida = '''')  and producao_ordem_servico.indicador_tipo_mov not in (2 ,4)  AND PRODUCAO_FASE.FASE_PRODUCAO = PRODUCAO_ORDEM_SERVICO.FASE_PRODUCAO   AND PRODUCAO_ORDEM_SERVICO.FASE_PRODUCAO = PRODUCAO_SETOR.FASE_PRODUCAO   AND PRODUCAO_ORDEM_SERVICO.SETOR_PRODUCAO = PRODUCAO_SETOR.SETOR_PRODUCAO   AND PRODUCAO_ORDEM_SERVICO.RECURSO_PRODUTIVO = PRODUCAO_RECURSOS.RECURSO_PRODUTIVO   AND PRODUCAO_ORDEM_SERVICO.FILIAL = FILIAIS.FILIAL ORDER BY PRODUCAO_ORDEM_SERVICO.ORDEM_SERVICO,  PRODUCAO_ORDEM_SERVICO.DATA',N'@P1 varchar(5)','ELITE'



exec sp_executesql N'
/* lx100107spk  CursorAdapter: cur_v_faturamento_05_estoque_sai_mat(Alias: v_faturamento_05_estoque_sai_mat)  */
SELECT ESTOQUE_SAI_MAT.REQ_MATERIAL, ESTOQUE_SAI_MAT.FILIAL,  ESTOQUE_SAI_MAT.ORDEM_SERVICO, ESTOQUE_SAI_MAT.SAIDA_POR_PECA,  ESTOQUE_SAI_MAT.EMISSAO, ESTOQUE_SAI_MAT.RESPONSAVEL,  ESTOQUE_SAI_MAT.DESTINO, ESTOQUE_SAI_MAT.OBS,  ESTOQUE_SAI_MAT.REQUISITANTE, ESTOQUE_SAI_MAT.FASE_PRODUCAO,  ESTOQUE_SAI_MAT.FORNECEDOR, ESTOQUE_SAI_MAT.CENTRO_CUSTO,  ESTOQUE_SAI_MAT.TIPO_MOVIMENTACAO, ESTOQUE_SAI_MAT.NF_ENTRADA,  ESTOQUE_SAI_MAT.NOME_CLIFOR, ESTOQUE_SAI_MAT.FILIAL_FATURAMENTO,  ESTOQUE_SAI_MAT.SERIE_NF, ESTOQUE_SAI_MAT.NF_SAIDA,  ESTOQUE_SAI_MAT.FILIAL_DESTINO, ESTOQUE_SAI_MAT.REQ_MATERIAL_DESTINO,  ESTOQUE_SAI_MAT.PEDIDO, ESTOQUE_SAI_MAT.NUMERO_EMBALAGEM,  ESTOQUE_SAI_MAT.PESO_LIQUIDO, ESTOQUE_SAI_MAT.PESO_BRUTO,  ESTOQUE_SAI_MAT.DIMENSOES_EMBALAGEM, FILIAIS.EMPRESA FROM ESTOQUE_SAI_MAT ESTOQUE_SAI_MAT, DBO.FILIAIS FILIAIS WHERE  estoque_sai_mat.filial = @P1 and estoque_sai_mat.filial_faturamento is null  and estoque_sai_mat.serie_nf is null and nf_saida is null  and estoque_sai_mat.nf_entrada is null   and estoque_sai_mat.pedido is null and estoque_sai_mat.nf_pendente = 1  and ((estoque_sai_mat.nome_clifor = @P2) or (estoque_sai_mat.nome_clifor is null))  AND FILIAIS.FILIAL = ESTOQUE_SAI_MAT.FILIAL',N'@P1 varchar(9),@P2 varchar(5)','DR VAREJO','ELITE'



-- oficina <> ldr
exec sp_executesql N'
/* lx100107spk  CursorAdapter: cur_v_faturamento_05_producao_os(Alias: v_faturamento_05_producao_os)  */
SELECT PRODUCAO_ORDEM_SERVICO.ORDEM_SERVICO,  PRODUCAO_ORDEM_SERVICO.RECURSO_PRODUTIVO,  PRODUCAO_ORDEM_SERVICO.FASE_PRODUCAO, PRODUCAO_ORDEM_SERVICO.DATA,  PRODUCAO_ORDEM_SERVICO.SETOR_PRODUCAO,  PRODUCAO_ORDEM_SERVICO.CONFERIDO_POR,  PRODUCAO_ORDEM_SERVICO.OBSERVACAO, PRODUCAO_FASE.DESC_FASE_PRODUCAO,  PRODUCAO_SETOR.DESC_SETOR_PRODUCAO, PRODUCAO_RECURSOS.TIPO_RECURSO,  PRODUCAO_RECURSOS.DESC_RECURSO, PRODUCAO_RECURSOS.RECURSO_PROPRIO,  PRODUCAO_ORDEM_SERVICO.ORDEM_SERVICO_PARALELA,  PRODUCAO_ORDEM_SERVICO.FILIAL, PRODUCAO_ORDEM_SERVICO.NF_SAIDA,  PRODUCAO_ORDEM_SERVICO.SERIE_NF, PRODUCAO_ORDEM_SERVICO.NF_ENTRADA,  PRODUCAO_ORDEM_SERVICO.INDICADOR_TIPO_MOV,  PRODUCAO_ORDEM_SERVICO.SEGUNDA_QUALIDADE, SPACE(5) AS RECURSO_ORIGEM,  SPACE(40) AS DESC_REC_ORIGEM, PRODUCAO_ORDEM_SERVICO.ACERTO_ENTRADA,  FILIAIS.EMPRESA FROM DBO.PRODUCAO_ORDEM_SERVICO PRODUCAO_ORDEM_SERVICO,  DBO.PRODUCAO_FASE PRODUCAO_FASE, DBO.PRODUCAO_SETOR PRODUCAO_SETOR,  DBO.PRODUCAO_RECURSOS PRODUCAO_RECURSOS, DBO.FILIAIS FILIAIS WHERE  producao_recursos.nome_clifor = @P1  and (producao_ordem_servico.serie_nf is null or producao_ordem_servico.serie_nf = '''')  and (producao_ordem_servico.nf_saida is null or producao_ordem_servico.nf_saida = '''')  and producao_ordem_servico.indicador_tipo_mov not in (2 ,4)  AND PRODUCAO_FASE.FASE_PRODUCAO = PRODUCAO_ORDEM_SERVICO.FASE_PRODUCAO   AND PRODUCAO_ORDEM_SERVICO.FASE_PRODUCAO = PRODUCAO_SETOR.FASE_PRODUCAO   AND PRODUCAO_ORDEM_SERVICO.SETOR_PRODUCAO = PRODUCAO_SETOR.SETOR_PRODUCAO   AND PRODUCAO_ORDEM_SERVICO.RECURSO_PRODUTIVO = PRODUCAO_RECURSOS.RECURSO_PRODUTIVO   AND PRODUCAO_ORDEM_SERVICO.FILIAL = FILIAIS.FILIAL ORDER BY PRODUCAO_ORDEM_SERVICO.ORDEM_SERVICO,  PRODUCAO_ORDEM_SERVICO.DATA',N'@P1 varchar(10)','LDR VAREJO'

exec sp_executesql N'
/* lx100107spk  CursorAdapter: cur_v_faturamento_05_estoque_sai_mat(Alias: v_faturamento_05_estoque_sai_mat)  */
SELECT ESTOQUE_SAI_MAT.REQ_MATERIAL, ESTOQUE_SAI_MAT.FILIAL,  ESTOQUE_SAI_MAT.ORDEM_SERVICO, ESTOQUE_SAI_MAT.SAIDA_POR_PECA,  ESTOQUE_SAI_MAT.EMISSAO, ESTOQUE_SAI_MAT.RESPONSAVEL,  ESTOQUE_SAI_MAT.DESTINO, ESTOQUE_SAI_MAT.OBS,  ESTOQUE_SAI_MAT.REQUISITANTE, ESTOQUE_SAI_MAT.FASE_PRODUCAO,  ESTOQUE_SAI_MAT.FORNECEDOR, ESTOQUE_SAI_MAT.CENTRO_CUSTO,  ESTOQUE_SAI_MAT.TIPO_MOVIMENTACAO, ESTOQUE_SAI_MAT.NF_ENTRADA,  ESTOQUE_SAI_MAT.NOME_CLIFOR, ESTOQUE_SAI_MAT.FILIAL_FATURAMENTO,  ESTOQUE_SAI_MAT.SERIE_NF, ESTOQUE_SAI_MAT.NF_SAIDA,  ESTOQUE_SAI_MAT.FILIAL_DESTINO, ESTOQUE_SAI_MAT.REQ_MATERIAL_DESTINO,  ESTOQUE_SAI_MAT.PEDIDO, ESTOQUE_SAI_MAT.NUMERO_EMBALAGEM,  ESTOQUE_SAI_MAT.PESO_LIQUIDO, ESTOQUE_SAI_MAT.PESO_BRUTO,  ESTOQUE_SAI_MAT.DIMENSOES_EMBALAGEM, FILIAIS.EMPRESA FROM ESTOQUE_SAI_MAT ESTOQUE_SAI_MAT, DBO.FILIAIS FILIAIS WHERE  estoque_sai_mat.filial = @P1 and estoque_sai_mat.filial_faturamento is null  and estoque_sai_mat.serie_nf is null and nf_saida is null  and estoque_sai_mat.nf_entrada is null   and estoque_sai_mat.pedido is null and estoque_sai_mat.nf_pendente = 1  and ((estoque_sai_mat.nome_clifor = @P2) or (estoque_sai_mat.nome_clifor is null))  AND FILIAIS.FILIAL = ESTOQUE_SAI_MAT.FILIAL',N'@P1 varchar(5),@P2 varchar(10)','ELITE','LDR VAREJO'


SELECT ESTOQUE_SAI_MAT.REQ_MATERIAL, ESTOQUE_SAI_MAT.FILIAL,  
ESTOQUE_SAI_MAT.ORDEM_SERVICO, ESTOQUE_SAI_MAT.SAIDA_POR_PECA,  
ESTOQUE_SAI_MAT.EMISSAO, ESTOQUE_SAI_MAT.RESPONSAVEL,  
ESTOQUE_SAI_MAT.DESTINO, ESTOQUE_SAI_MAT.OBS,  ESTOQUE_SAI_MAT.REQUISITANTE, 
ESTOQUE_SAI_MAT.FASE_PRODUCAO,  ESTOQUE_SAI_MAT.FORNECEDOR, 
ESTOQUE_SAI_MAT.CENTRO_CUSTO,  ESTOQUE_SAI_MAT.TIPO_MOVIMENTACAO, 
ESTOQUE_SAI_MAT.NF_ENTRADA,  ESTOQUE_SAI_MAT.NOME_CLIFOR, 
ESTOQUE_SAI_MAT.FILIAL_FATURAMENTO,  ESTOQUE_SAI_MAT.SERIE_NF, 
ESTOQUE_SAI_MAT.NF_SAIDA,  ESTOQUE_SAI_MAT.FILIAL_DESTINO, 
ESTOQUE_SAI_MAT.REQ_MATERIAL_DESTINO,  ESTOQUE_SAI_MAT.PEDIDO, 
ESTOQUE_SAI_MAT.NUMERO_EMBALAGEM,  ESTOQUE_SAI_MAT.PESO_LIQUIDO, 
ESTOQUE_SAI_MAT.PESO_BRUTO,  ESTOQUE_SAI_MAT.DIMENSOES_EMBALAGEM, 
FILIAIS.EMPRESA FROM ESTOQUE_SAI_MAT ESTOQUE_SAI_MAT, DBO.FILIAIS FILIAIS 
WHERE  estoque_sai_mat.filial = 'DR VAREJO' 
and estoque_sai_mat.filial_faturamento is null  
and estoque_sai_mat.serie_nf is null and nf_saida is null  
and estoque_sai_mat.nf_entrada is null   and estoque_sai_mat.pedido is null 
and estoque_sai_mat.nf_pendente = 1  
and ((estoque_sai_mat.nome_clifor = 'ELITE') or (estoque_sai_mat.nome_clifor is null))  
AND FILIAIS.FILIAL = ESTOQUE_SAI_MAT.FILIAL



SELECT ESTOQUE_SAI_MAT.REQ_MATERIAL, ESTOQUE_SAI_MAT.FILIAL,  
ESTOQUE_SAI_MAT.ORDEM_SERVICO, ESTOQUE_SAI_MAT.SAIDA_POR_PECA,  
ESTOQUE_SAI_MAT.EMISSAO, ESTOQUE_SAI_MAT.RESPONSAVEL,  
ESTOQUE_SAI_MAT.DESTINO, ESTOQUE_SAI_MAT.OBS,  ESTOQUE_SAI_MAT.REQUISITANTE, 
ESTOQUE_SAI_MAT.FASE_PRODUCAO,  ESTOQUE_SAI_MAT.FORNECEDOR, 
ESTOQUE_SAI_MAT.CENTRO_CUSTO,  ESTOQUE_SAI_MAT.TIPO_MOVIMENTACAO, 
ESTOQUE_SAI_MAT.NF_ENTRADA,  ESTOQUE_SAI_MAT.NOME_CLIFOR, 
ESTOQUE_SAI_MAT.FILIAL_FATURAMENTO,  ESTOQUE_SAI_MAT.SERIE_NF, 
ESTOQUE_SAI_MAT.NF_SAIDA,  ESTOQUE_SAI_MAT.FILIAL_DESTINO, 
ESTOQUE_SAI_MAT.REQ_MATERIAL_DESTINO,  ESTOQUE_SAI_MAT.PEDIDO, 
ESTOQUE_SAI_MAT.NUMERO_EMBALAGEM,  ESTOQUE_SAI_MAT.PESO_LIQUIDO, 
ESTOQUE_SAI_MAT.PESO_BRUTO,  ESTOQUE_SAI_MAT.DIMENSOES_EMBALAGEM, 
FILIAIS.EMPRESA FROM ESTOQUE_SAI_MAT ESTOQUE_SAI_MAT, DBO.FILIAIS FILIAIS 
WHERE  estoque_sai_mat.filial = 'DR VAREJO' 
and estoque_sai_mat.filial_faturamento is not null  
--and estoque_sai_mat.serie_nf is null and nf_saida is null  
--and estoque_sai_mat.nf_entrada is null   and estoque_sai_mat.pedido is null 
and estoque_sai_mat.nf_pendente = 0  
and ((estoque_sai_mat.nome_clifor = 'ELITE') or (estoque_sai_mat.nome_clifor is null))  
AND FILIAIS.FILIAL = ESTOQUE_SAI_MAT.FILIAL


exec sp_executesql N'
/* lx100107spk  CursorAdapter: cur_v_faturamento_05_estoque_valida(Alias: v_faturamento_05_estoque_valida)  */
SELECT    ESTOQUE_SAI1_MAT.MATERIAL, ESTOQUE_SAI1_MAT.COR_MATERIAL, ESTOQUE_SAI1_MAT.FILIAL,   ESTOQUE_SAI1_MAT.QTDE,  ESTOQUE_SAI1_MAT.REQ_MATERIAL,   ESTOQUE_SAI1_MAT.QTDE_AUX, ESTOQUE_SAI1_MAT.ORDEM_PRODUCAO,  MATERIAIS_CORES.DESC_COR_MATERIAL,  MATERIAIS.UNID_AUXILIAR,  MATERIAIS.CTRL_UNID_AUX,  MATERIAIS.CTRL_PARTIDAS,  MATERIAIS.CTRL_PECAS,  MATERIAIS.DESC_MATERIAL, MATERIAIS.UNID_ESTOQUE, MATERIAIS.CTRL_PECAS_PARCIAL, MATERIAIS.LARGURA,   ESTOQUE_SAI1_MAT.ITEM,  ESTOQUE_SAI1_MAT.CUSTO, ESTOQUE_SAI1_MAT.DATA_CUSTO, (CUSTO*QTDE) AS TOTAL_LINHA,  MATERIAIS.UNID_FICHA_TEC,  MATERIAIS.FATOR_CONVERSAO, QTDE*FATOR_CONVERSAO AS QTDE_UNID_FICHA,  ESTOQUE_SAI1_MAT.MATAR_SALDO_RESERVA, ESTOQUE_SAI1_MAT.FILIAL_FATURAMENTO,  ESTOQUE_SAI1_MAT.NF_SAIDA, ESTOQUE_SAI1_MAT.SERIE_NF,  ESTOQUE_SAI1_MAT.ICMS,  ISNULL(VENDAS_MATERIAL.DESCONTO_ITEM, 0) DESCONTO_ITEM, ISNULL(VENDAS_MATERIAL.PRECO, 0) PRECO, CONVERT(NUMERIC (14, 2), 0) VALOR,   ESTOQUE_SAI1_MAT.FATOR_CONVERSAO_UNIDADE,   ESTOQUE_SAI1_MAT.UNIDADE_FATURAMENTO, (ISNULL(VENDAS_MATERIAL.PRECO, 0)/CASE WHEN FATOR_CONVERSAO_UNIDADE = 0 THEN 1 ELSE  FATOR_CONVERSAO_UNIDADE END) AS PRECO_MATERIAL,   ESTOQUE_SAI1_MAT.PEDIDO,  ESTOQUE_SAI1_MAT.ENTREGA,  ISNULL(VENDAS_MATERIAL.IPI, 0) IPI, ESTOQUE_SAI1_MAT.VALOR_BRUTO,  MATERIAIS.COMPRIMENTO,    VENDAS.CLIENTE_ATACADO, VENDAS.ACEITA_PECAS_COM_CORTE, VENDAS.CONDICAO_PGTO, COND_ATAC_PGTOS.DESC_COND_PGTO, VENDAS.TRANSPORTADORA,VENDAS.TRANSP_REDESPACHO,VENDAS.DATA_FATURAMENTO_RELATIVO,VENDAS.TIPO_FRETE,VENDAS.DESCONTO_SOBRE_1,VENDAS.DESCONTO_SOBRE_2,VENDAS.DESCONTO_SOBRE_3,VENDAS.DESCONTO_SOBRE_4,VENDAS.DESCONTO_COND_PGTO,  VENDAS.REPRESENTANTE, VENDAS.COMISSAO,  VENDAS.GERENTE, VENDAS.COMISSAO_GERENTE,   CASE WHEN ISNULL(VENDAS.TOT_VALOR_ORIGINAL, 0) <> 0 AND  VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)-ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI > 0  THEN  CONVERT(NUMERIC(14, 2), (VENDAS.DESCONTO/(VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)- ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI))*100) ELSE 0 END PORC_DESCONTO_CALCULADO,  CASE WHEN ISNULL(VENDAS.TOT_VALOR_ORIGINAL, 0) <> 0 AND VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)-ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI > 0 THEN   CONVERT(NUMERIC(14, 2), (VENDAS.ENCARGO/(VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)- ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI))*100) ELSE 0 END PORC_ENCARGO_CALCULADO, CASE WHEN ISNULL(VENDAS.TOT_VALOR_ORIGINAL, 0) <> 0 AND 
VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)-ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI > 0 THEN   CONVERT(NUMERIC(14, 2), 
(VENDAS.DESCONTO_COND_PGTO/(VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)- ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI))*100) ELSE 0 END 
PORC_DESCONTO_COND_PGTO_CALCULADO, CASE WHEN ISNULL(VENDAS.TOT_VALOR_ORIGINAL, 0) <> 0  AND VENDAS.TOT_VALOR_ORIGINAL-ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI > 0 THEN  
CONVERT(NUMERIC(14, 2), (ISNULL(VENDAS.RECARGO, 0)/(VENDAS.TOT_VALOR_ORIGINAL-ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI))*100)  ELSE 0 END RECARGO,  ENTREGA_CIF , 
MATERIAIS.CLASSIF_FISCAL, CLASSIF_FISCAL.IPI AS CLASSIF_IPI,  MATERIAIS.TRIBUT_ORIGEM, MATERIAIS.TRIBUT_ICMS, VENDAS.MOEDA, VENDAS.PORCENTAGEM_ACERTO, 
VENDAS.PORC_DESCONTO,VENDAS.PORC_DESCONTO_BRUTO,VENDAS.PORC_DESCONTO_COND_PGTO,VENDAS.PORC_DESCONTO_DIGITADO,VENDAS.PORC_ENCARGO, VENDAS.NOME_CLIFOR_ENTREGA, 
ISNULL(MATERIAIS_INDICADOR_CFOP.INDICADOR_CFOP, CASE WHEN ISNULL(FILIAIS.INDICA_CFOP_SOMENTE_REVENDA, 0) = 1 AND MATERIAIS.INDICADOR_CFOP = 10 THEN 11 ELSE 
MATERIAIS.INDICADOR_CFOP END) INDICADOR_CFOP, DESCRICAO_INDICADOR_CFOP     , ESTOQUE_SAI1_MAT.QTDE AS QUANTIDADE, COD_TABELA_FILHA=''M'',  TRIBUT_ICMS.DESCRICAO AS 
TRIBUT_ICMS_DESCRICAO,  TRIBUT_ORIGEM.DESCRICAO AS TRIBUT_ORIGEM_DESCRICAO,  CLASSIF_FISCAL.DESC_CLASSIFICACAO, ESTOQUE_SAI1_MAT.VALOR_BRUTO AS TIMESTAMP, CONTA_CONTABIL = CASE 
WHEN @P1 = ''D'' OR @P2 = ''N'' THEN MATERIAIS.CONTA_CONTABIL_DEV_COMPRA WHEN @P3 = ''V'' OR @P4 = ''G'' THEN MATERIAIS.CONTA_CONTABIL_VENDA ELSE MATERIAIS.CONTA_CONTABIL END,  
CTB_CONTA_PLANO.DESC_CONTA,  FAIXA=''1'', GERAR_ITEM= CONVERT(BIT,1), ESTOQUE_SAI1_MAT.ITEM_IMPRESSAO , MATERIAIS.UNID_ESTOQUE AS UNIDADE, VENDAS.DESCONTO, VENDAS.RECARGO, 
VENDAS.ENCARGO  FROM (ESTOQUE_SAI1_MAT   LEFT JOIN VENDAS ON ESTOQUE_SAI1_MAT.PEDIDO = VENDAS.PEDIDO)    JOIN MATERIAIS ON ESTOQUE_SAI1_MAT.MATERIAL = MATERIAIS.MATERIAL    JOIN 
MATERIAIS_CORES ON ESTOQUE_SAI1_MAT.MATERIAL = MATERIAIS_CORES.MATERIAL AND ESTOQUE_SAI1_MAT.COR_MATERIAL = MATERIAIS_CORES.COR_MATERIAL    JOIN CLASSIF_FISCAL ON MATERIAIS.CLASSIF_FISCAL = CLASSIF_FISCAL.CLASSIF_FISCAL    JOIN FILIAIS ON ESTOQUE_SAI1_MAT.FILIAL = FILIAIS.FILIAL   LEFT JOIN VENDAS_MATERIAL ON ESTOQUE_SAI1_MAT.PEDIDO = VENDAS_MATERIAL.PEDIDO  AND ESTOQUE_SAI1_MAT.MATERIAL = VENDAS_MATERIAL.MATERIAL AND  ESTOQUE_SAI1_MAT.COR_MATERIAL = VENDAS_MATERIAL.COR_MATERIAL  LEFT JOIN TRIBUT_ICMS ON (MATERIAIS.TRIBUT_ICMS = TRIBUT_ICMS.TRIBUT_ICMS)   LEFT JOIN TRIBUT_ORIGEM ON (MATERIAIS.TRIBUT_ORIGEM = TRIBUT_ORIGEM.TRIBUT_ORIGEM)  LEFT JOIN CTB_CONTA_PLANO ON (CASE WHEN @P5 = ''D'' OR @P6 = ''N'' THEN MATERIAIS.CONTA_CONTABIL_DEV_COMPRA WHEN @P7 = ''V'' OR @P8 = ''G'' THEN MATERIAIS.CONTA_CONTABIL_VENDA ELSE MATERIAIS.CONTA_CONTABIL END = CTB_CONTA_PLANO.CONTA_CONTABIL)  LEFT JOIN COND_ATAC_PGTOS COND_ATAC_PGTOS ON (VENDAS.CONDICAO_PGTO=COND_ATAC_PGTOS.CONDICAO_PGTO)   JOIN FILIAIS FILIAL_FATURAMENTO ON FILIAL_FATURAMENTO.FILIAL = @P9 LEFT JOIN MATERIAIS_INDICADOR_CFOP ON MATERIAIS.MATERIAL = MATERIAIS_INDICADOR_CFOP.MATERIAL AND FILIAL_FATURAMENTO.FILIAL = MATERIAIS_INDICADOR_CFOP.FILIAL LEFT JOIN CTB_LX_INDICADOR_CFOP ON ISNULL(MATERIAIS_INDICADOR_CFOP.INDICADOR_CFOP, CASE WHEN ISNULL(FILIAIS.INDICA_CFOP_SOMENTE_REVENDA, 0) = 1 AND MATERIAIS.INDICADOR_CFOP = 10 THEN 11 ELSE MATERIAIS.INDICADOR_CFOP END) = CTB_LX_INDICADOR_CFOP.INDICADOR_CFOP  WHERE   estoque_sai1_mat.filial IN (SELECT FILIAL FROM FILIAIS WHERE MATRIZ_FISCAL = @P10)  and req_material = @P11  ORDER BY ESTOQUE_SAI1_MAT.FILIAL, ESTOQUE_SAI1_MAT.REQ_MATERIAL,  ESTOQUE_SAI1_MAT.MATERIAL, ESTOQUE_SAI1_MAT.COR_MATERIAL',N'@P1 varchar(1),@P2 varchar(1),@P3 varchar(1),@P4 varchar(1),@P5 varchar(1),@P6 varchar(1),@P7 varchar(1),@P8 varchar(1),@P9 varchar(9),@P10 varchar(9),@P11 varchar(6)','R','R','R','R','R','R','R','R','DR VAREJO','DR VAREJO','159566'



--- buscar requisição
exec sp_executesql N'
/* lx100107spk  CursorAdapter: cur_v_faturamento_05_estoque_sai_mat(Alias: v_faturamento_05_estoque_sai_mat)  */
SELECT ESTOQUE_SAI_MAT.REQ_MATERIAL, ESTOQUE_SAI_MAT.FILIAL,  ESTOQUE_SAI_MAT.ORDEM_SERVICO, ESTOQUE_SAI_MAT.SAIDA_POR_PECA,  ESTOQUE_SAI_MAT.EMISSAO, ESTOQUE_SAI_MAT.RESPONSAVEL,  ESTOQUE_SAI_MAT.DESTINO, ESTOQUE_SAI_MAT.OBS,  ESTOQUE_SAI_MAT.REQUISITANTE, ESTOQUE_SAI_MAT.FASE_PRODUCAO,  ESTOQUE_SAI_MAT.FORNECEDOR, ESTOQUE_SAI_MAT.CENTRO_CUSTO,  ESTOQUE_SAI_MAT.TIPO_MOVIMENTACAO, ESTOQUE_SAI_MAT.NF_ENTRADA,  ESTOQUE_SAI_MAT.NOME_CLIFOR, ESTOQUE_SAI_MAT.FILIAL_FATURAMENTO,  ESTOQUE_SAI_MAT.SERIE_NF, ESTOQUE_SAI_MAT.NF_SAIDA,  ESTOQUE_SAI_MAT.FILIAL_DESTINO, ESTOQUE_SAI_MAT.REQ_MATERIAL_DESTINO,  ESTOQUE_SAI_MAT.PEDIDO, ESTOQUE_SAI_MAT.NUMERO_EMBALAGEM,  ESTOQUE_SAI_MAT.PESO_LIQUIDO, ESTOQUE_SAI_MAT.PESO_BRUTO,  ESTOQUE_SAI_MAT.DIMENSOES_EMBALAGEM, FILIAIS.EMPRESA FROM ESTOQUE_SAI_MAT ESTOQUE_SAI_MAT, DBO.FILIAIS FILIAIS WHERE  estoque_sai_mat.filial = @P1 and estoque_sai_mat.filial_faturamento is null  and estoque_sai_mat.serie_nf is null and nf_saida is null  and estoque_sai_mat.nf_entrada is null   and estoque_sai_mat.pedido is null and estoque_sai_mat.nf_pendente = 1  and ((estoque_sai_mat.nome_clifor = @P2) or (estoque_sai_mat.nome_clifor is null))  and req_material = ''159565 '' AND FILIAIS.FILIAL = ESTOQUE_SAI_MAT.FILIAL',N'@P1 varchar(9),@P2 varchar(5)','DR VAREJO','ELITE'

--- materiais da requisicao

exec sp_executesql N'
/* lx100107spk  CursorAdapter: cur_v_faturamento_05_estoque_valida(Alias: v_faturamento_05_estoque_valida)  */
SELECT    ESTOQUE_SAI1_MAT.MATERIAL, ESTOQUE_SAI1_MAT.COR_MATERIAL, ESTOQUE_SAI1_MAT.FILIAL,   ESTOQUE_SAI1_MAT.QTDE,  ESTOQUE_SAI1_MAT.REQ_MATERIAL,   ESTOQUE_SAI1_MAT.QTDE_AUX, ESTOQUE_SAI1_MAT.ORDEM_PRODUCAO,  MATERIAIS_CORES.DESC_COR_MATERIAL,  MATERIAIS.UNID_AUXILIAR,  MATERIAIS.CTRL_UNID_AUX,  MATERIAIS.CTRL_PARTIDAS,  MATERIAIS.CTRL_PECAS,  MATERIAIS.DESC_MATERIAL, MATERIAIS.UNID_ESTOQUE, MATERIAIS.CTRL_PECAS_PARCIAL, MATERIAIS.LARGURA,   ESTOQUE_SAI1_MAT.ITEM,  ESTOQUE_SAI1_MAT.CUSTO, ESTOQUE_SAI1_MAT.DATA_CUSTO, (CUSTO*QTDE) AS TOTAL_LINHA,  MATERIAIS.UNID_FICHA_TEC,  MATERIAIS.FATOR_CONVERSAO, QTDE*FATOR_CONVERSAO AS QTDE_UNID_FICHA,  ESTOQUE_SAI1_MAT.MATAR_SALDO_RESERVA, ESTOQUE_SAI1_MAT.FILIAL_FATURAMENTO,  ESTOQUE_SAI1_MAT.NF_SAIDA, ESTOQUE_SAI1_MAT.SERIE_NF,  ESTOQUE_SAI1_MAT.ICMS,  ISNULL(VENDAS_MATERIAL.DESCONTO_ITEM, 0) DESCONTO_ITEM, ISNULL(VENDAS_MATERIAL.PRECO, 0) PRECO, CONVERT(NUMERIC (14, 2), 0) VALOR,   ESTOQUE_SAI1_MAT.FATOR_CONVERSAO_UNIDADE,   ESTOQUE_SAI1_MAT.UNIDADE_FATURAMENTO, (ISNULL(VENDAS_MATERIAL.PRECO, 0)/CASE WHEN FATOR_CONVERSAO_UNIDADE = 0 THEN 1 ELSE  FATOR_CONVERSAO_UNIDADE END) AS PRECO_MATERIAL,   ESTOQUE_SAI1_MAT.PEDIDO,  ESTOQUE_SAI1_MAT.ENTREGA,  ISNULL(VENDAS_MATERIAL.IPI, 0) IPI, ESTOQUE_SAI1_MAT.VALOR_BRUTO,  MATERIAIS.COMPRIMENTO,    VENDAS.CLIENTE_ATACADO, VENDAS.ACEITA_PECAS_COM_CORTE, VENDAS.CONDICAO_PGTO, COND_ATAC_PGTOS.DESC_COND_PGTO, VENDAS.TRANSPORTADORA,VENDAS.TRANSP_REDESPACHO,VENDAS.DATA_FATURAMENTO_RELATIVO,VENDAS.TIPO_FRETE,VENDAS.DESCONTO_SOBRE_1,VENDAS.DESCONTO_SOBRE_2,VENDAS.DESCONTO_SOBRE_3,VENDAS.DESCONTO_SOBRE_4,VENDAS.DESCONTO_COND_PGTO,  VENDAS.REPRESENTANTE, VENDAS.COMISSAO,  VENDAS.GERENTE, VENDAS.COMISSAO_GERENTE,   CASE WHEN ISNULL(VENDAS.TOT_VALOR_ORIGINAL, 0) <> 0 AND  VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)-ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI > 0  THEN  CONVERT(NUMERIC(14, 2), (VENDAS.DESCONTO/(VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)- ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI))*100) ELSE 0 END PORC_DESCONTO_CALCULADO,  CASE WHEN ISNULL(VENDAS.TOT_VALOR_ORIGINAL, 0) <> 0 AND VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)-ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI > 0 THEN   CONVERT(NUMERIC(14, 2), (VENDAS.ENCARGO/(VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)- ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI))*100) ELSE 0 END PORC_ENCARGO_CALCULADO, CASE WHEN ISNULL(VENDAS.TOT_VALOR_ORIGINAL, 0) <> 0 AND 
VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)-ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI > 0 THEN   CONVERT(NUMERIC(14, 2), 
(VENDAS.DESCONTO_COND_PGTO/(VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)- ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI))*100) ELSE 0 END 
PORC_DESCONTO_COND_PGTO_CALCULADO, CASE WHEN ISNULL(VENDAS.TOT_VALOR_ORIGINAL, 0) <> 0  AND VENDAS.TOT_VALOR_ORIGINAL-ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI > 0 THEN  
CONVERT(NUMERIC(14, 2), (ISNULL(VENDAS.RECARGO, 0)/(VENDAS.TOT_VALOR_ORIGINAL-ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI))*100)  ELSE 0 END RECARGO,  ENTREGA_CIF , 
MATERIAIS.CLASSIF_FISCAL, CLASSIF_FISCAL.IPI AS CLASSIF_IPI,  MATERIAIS.TRIBUT_ORIGEM, MATERIAIS.TRIBUT_ICMS, VENDAS.MOEDA, VENDAS.PORCENTAGEM_ACERTO, 
VENDAS.PORC_DESCONTO,VENDAS.PORC_DESCONTO_BRUTO,VENDAS.PORC_DESCONTO_COND_PGTO,VENDAS.PORC_DESCONTO_DIGITADO,VENDAS.PORC_ENCARGO, VENDAS.NOME_CLIFOR_ENTREGA, 
ISNULL(MATERIAIS_INDICADOR_CFOP.INDICADOR_CFOP, CASE WHEN ISNULL(FILIAIS.INDICA_CFOP_SOMENTE_REVENDA, 0) = 1 AND MATERIAIS.INDICADOR_CFOP = 10 THEN 11 ELSE 
MATERIAIS.INDICADOR_CFOP END) INDICADOR_CFOP, DESCRICAO_INDICADOR_CFOP     , ESTOQUE_SAI1_MAT.QTDE AS QUANTIDADE, COD_TABELA_FILHA=''M'',  TRIBUT_ICMS.DESCRICAO AS 
TRIBUT_ICMS_DESCRICAO,  TRIBUT_ORIGEM.DESCRICAO AS TRIBUT_ORIGEM_DESCRICAO,  CLASSIF_FISCAL.DESC_CLASSIFICACAO, ESTOQUE_SAI1_MAT.VALOR_BRUTO AS TIMESTAMP, CONTA_CONTABIL = CASE 
WHEN @P1 = ''D'' OR @P2 = ''N'' THEN MATERIAIS.CONTA_CONTABIL_DEV_COMPRA WHEN @P3 = ''V'' OR @P4 = ''G'' THEN MATERIAIS.CONTA_CONTABIL_VENDA ELSE MATERIAIS.CONTA_CONTABIL END,  
CTB_CONTA_PLANO.DESC_CONTA,  FAIXA=''1'', GERAR_ITEM= CONVERT(BIT,1), ESTOQUE_SAI1_MAT.ITEM_IMPRESSAO , MATERIAIS.UNID_ESTOQUE AS UNIDADE, VENDAS.DESCONTO, VENDAS.RECARGO, 
VENDAS.ENCARGO  FROM (ESTOQUE_SAI1_MAT   LEFT JOIN VENDAS ON ESTOQUE_SAI1_MAT.PEDIDO = VENDAS.PEDIDO)    JOIN MATERIAIS ON ESTOQUE_SAI1_MAT.MATERIAL = MATERIAIS.MATERIAL    JOIN 
MATERIAIS_CORES ON ESTOQUE_SAI1_MAT.MATERIAL = MATERIAIS_CORES.MATERIAL AND ESTOQUE_SAI1_MAT.COR_MATERIAL = MATERIAIS_CORES.COR_MATERIAL    JOIN CLASSIF_FISCAL ON MATERIAIS.CLASSIF_FISCAL = CLASSIF_FISCAL.CLASSIF_FISCAL    JOIN FILIAIS ON ESTOQUE_SAI1_MAT.FILIAL = FILIAIS.FILIAL   LEFT JOIN VENDAS_MATERIAL ON ESTOQUE_SAI1_MAT.PEDIDO = VENDAS_MATERIAL.PEDIDO  AND ESTOQUE_SAI1_MAT.MATERIAL = VENDAS_MATERIAL.MATERIAL AND  ESTOQUE_SAI1_MAT.COR_MATERIAL = VENDAS_MATERIAL.COR_MATERIAL  LEFT JOIN TRIBUT_ICMS ON (MATERIAIS.TRIBUT_ICMS = TRIBUT_ICMS.TRIBUT_ICMS)   LEFT JOIN TRIBUT_ORIGEM ON (MATERIAIS.TRIBUT_ORIGEM = TRIBUT_ORIGEM.TRIBUT_ORIGEM)  LEFT JOIN CTB_CONTA_PLANO ON (CASE WHEN @P5 = ''D'' OR @P6 = ''N'' THEN MATERIAIS.CONTA_CONTABIL_DEV_COMPRA WHEN @P7 = ''V'' OR @P8 = ''G'' THEN MATERIAIS.CONTA_CONTABIL_VENDA ELSE MATERIAIS.CONTA_CONTABIL END = CTB_CONTA_PLANO.CONTA_CONTABIL)  LEFT JOIN COND_ATAC_PGTOS COND_ATAC_PGTOS ON (VENDAS.CONDICAO_PGTO=COND_ATAC_PGTOS.CONDICAO_PGTO)   JOIN FILIAIS FILIAL_FATURAMENTO ON FILIAL_FATURAMENTO.FILIAL = @P9 LEFT JOIN MATERIAIS_INDICADOR_CFOP ON MATERIAIS.MATERIAL = MATERIAIS_INDICADOR_CFOP.MATERIAL AND FILIAL_FATURAMENTO.FILIAL = MATERIAIS_INDICADOR_CFOP.FILIAL LEFT JOIN CTB_LX_INDICADOR_CFOP ON ISNULL(MATERIAIS_INDICADOR_CFOP.INDICADOR_CFOP, CASE WHEN ISNULL(FILIAIS.INDICA_CFOP_SOMENTE_REVENDA, 0) = 1 AND MATERIAIS.INDICADOR_CFOP = 10 THEN 11 ELSE MATERIAIS.INDICADOR_CFOP END) = CTB_LX_INDICADOR_CFOP.INDICADOR_CFOP  WHERE   estoque_sai1_mat.filial IN (SELECT FILIAL FROM FILIAIS WHERE MATRIZ_FISCAL = @P10)  and req_material = @P11  ORDER BY ESTOQUE_SAI1_MAT.FILIAL, ESTOQUE_SAI1_MAT.REQ_MATERIAL,  ESTOQUE_SAI1_MAT.MATERIAL, ESTOQUE_SAI1_MAT.COR_MATERIAL',N'@P1 varchar(1),@P2 varchar(1),@P3 varchar(1),@P4 varchar(1),@P5 varchar(1),@P6 varchar(1),@P7 varchar(1),@P8 varchar(1),@P9 varchar(9),@P10 varchar(9),@P11 varchar(6)','R','R','R','R','R','R','R','R','DR VAREJO','DR VAREJO','159565'



--- buscar requisição
exec sp_executesql N'
/* lx100107spk  CursorAdapter: cur_v_faturamento_05_estoque_sai_mat(Alias: v_faturamento_05_estoque_sai_mat)  */
SELECT ESTOQUE_SAI_MAT.REQ_MATERIAL, ESTOQUE_SAI_MAT.FILIAL,  ESTOQUE_SAI_MAT.ORDEM_SERVICO, ESTOQUE_SAI_MAT.SAIDA_POR_PECA,  ESTOQUE_SAI_MAT.EMISSAO, ESTOQUE_SAI_MAT.RESPONSAVEL,  ESTOQUE_SAI_MAT.DESTINO, ESTOQUE_SAI_MAT.OBS,  ESTOQUE_SAI_MAT.REQUISITANTE, ESTOQUE_SAI_MAT.FASE_PRODUCAO,  ESTOQUE_SAI_MAT.FORNECEDOR, ESTOQUE_SAI_MAT.CENTRO_CUSTO,  ESTOQUE_SAI_MAT.TIPO_MOVIMENTACAO, ESTOQUE_SAI_MAT.NF_ENTRADA,  ESTOQUE_SAI_MAT.NOME_CLIFOR, ESTOQUE_SAI_MAT.FILIAL_FATURAMENTO,  ESTOQUE_SAI_MAT.SERIE_NF, ESTOQUE_SAI_MAT.NF_SAIDA,  ESTOQUE_SAI_MAT.FILIAL_DESTINO, ESTOQUE_SAI_MAT.REQ_MATERIAL_DESTINO,  ESTOQUE_SAI_MAT.PEDIDO, ESTOQUE_SAI_MAT.NUMERO_EMBALAGEM,  ESTOQUE_SAI_MAT.PESO_LIQUIDO, ESTOQUE_SAI_MAT.PESO_BRUTO,  ESTOQUE_SAI_MAT.DIMENSOES_EMBALAGEM, FILIAIS.EMPRESA FROM ESTOQUE_SAI_MAT ESTOQUE_SAI_MAT, DBO.FILIAIS FILIAIS WHERE  estoque_sai_mat.filial = @P1 and estoque_sai_mat.filial_faturamento is null  and estoque_sai_mat.serie_nf is null and nf_saida is null  and estoque_sai_mat.nf_entrada is null   and estoque_sai_mat.pedido is null and estoque_sai_mat.nf_pendente = 1  and ((estoque_sai_mat.nome_clifor = @P2) or (estoque_sai_mat.nome_clifor is null))  and req_material = ''159565 '' AND FILIAIS.FILIAL = ESTOQUE_SAI_MAT.FILIAL',N'@P1 varchar(9),@P2 varchar(5)','DR VAREJO','ELITE'

--- materiais da requisicao

exec sp_executesql N'
/* lx100107spk  CursorAdapter: cur_v_faturamento_05_estoque_valida(Alias: v_faturamento_05_estoque_valida)  */
SELECT    ESTOQUE_SAI1_MAT.MATERIAL, ESTOQUE_SAI1_MAT.COR_MATERIAL, ESTOQUE_SAI1_MAT.FILIAL,   ESTOQUE_SAI1_MAT.QTDE,  ESTOQUE_SAI1_MAT.REQ_MATERIAL,   ESTOQUE_SAI1_MAT.QTDE_AUX, ESTOQUE_SAI1_MAT.ORDEM_PRODUCAO,  MATERIAIS_CORES.DESC_COR_MATERIAL,  MATERIAIS.UNID_AUXILIAR,  MATERIAIS.CTRL_UNID_AUX,  MATERIAIS.CTRL_PARTIDAS,  MATERIAIS.CTRL_PECAS,  MATERIAIS.DESC_MATERIAL, MATERIAIS.UNID_ESTOQUE, MATERIAIS.CTRL_PECAS_PARCIAL, MATERIAIS.LARGURA,   ESTOQUE_SAI1_MAT.ITEM,  ESTOQUE_SAI1_MAT.CUSTO, ESTOQUE_SAI1_MAT.DATA_CUSTO, (CUSTO*QTDE) AS TOTAL_LINHA,  MATERIAIS.UNID_FICHA_TEC,  MATERIAIS.FATOR_CONVERSAO, QTDE*FATOR_CONVERSAO AS QTDE_UNID_FICHA,  ESTOQUE_SAI1_MAT.MATAR_SALDO_RESERVA, ESTOQUE_SAI1_MAT.FILIAL_FATURAMENTO,  ESTOQUE_SAI1_MAT.NF_SAIDA, ESTOQUE_SAI1_MAT.SERIE_NF,  ESTOQUE_SAI1_MAT.ICMS,  ISNULL(VENDAS_MATERIAL.DESCONTO_ITEM, 0) DESCONTO_ITEM, ISNULL(VENDAS_MATERIAL.PRECO, 0) PRECO, CONVERT(NUMERIC (14, 2), 0) VALOR,   ESTOQUE_SAI1_MAT.FATOR_CONVERSAO_UNIDADE,   ESTOQUE_SAI1_MAT.UNIDADE_FATURAMENTO, (ISNULL(VENDAS_MATERIAL.PRECO, 0)/CASE WHEN FATOR_CONVERSAO_UNIDADE = 0 THEN 1 ELSE  FATOR_CONVERSAO_UNIDADE END) AS PRECO_MATERIAL,   ESTOQUE_SAI1_MAT.PEDIDO,  ESTOQUE_SAI1_MAT.ENTREGA,  ISNULL(VENDAS_MATERIAL.IPI, 0) IPI, ESTOQUE_SAI1_MAT.VALOR_BRUTO,  MATERIAIS.COMPRIMENTO,    VENDAS.CLIENTE_ATACADO, VENDAS.ACEITA_PECAS_COM_CORTE, VENDAS.CONDICAO_PGTO, COND_ATAC_PGTOS.DESC_COND_PGTO, VENDAS.TRANSPORTADORA,VENDAS.TRANSP_REDESPACHO,VENDAS.DATA_FATURAMENTO_RELATIVO,VENDAS.TIPO_FRETE,VENDAS.DESCONTO_SOBRE_1,VENDAS.DESCONTO_SOBRE_2,VENDAS.DESCONTO_SOBRE_3,VENDAS.DESCONTO_SOBRE_4,VENDAS.DESCONTO_COND_PGTO,  VENDAS.REPRESENTANTE, VENDAS.COMISSAO,  VENDAS.GERENTE, VENDAS.COMISSAO_GERENTE,   CASE WHEN ISNULL(VENDAS.TOT_VALOR_ORIGINAL, 0) <> 0 AND  VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)-ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI > 0  THEN  CONVERT(NUMERIC(14, 2), (VENDAS.DESCONTO/(VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)- ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI))*100) ELSE 0 END PORC_DESCONTO_CALCULADO,  CASE WHEN ISNULL(VENDAS.TOT_VALOR_ORIGINAL, 0) <> 0 AND VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)-ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI > 0 THEN   CONVERT(NUMERIC(14, 2), (VENDAS.ENCARGO/(VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)- ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI))*100) ELSE 0 END PORC_ENCARGO_CALCULADO, CASE WHEN ISNULL(VENDAS.TOT_VALOR_ORIGINAL, 0) <> 0 AND 
VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)-ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI > 0 THEN   CONVERT(NUMERIC(14, 2), 
(VENDAS.DESCONTO_COND_PGTO/(VENDAS.TOT_VALOR_ORIGINAL-VENDAS.ENCARGO+VENDAS.DESCONTO+ISNULL(VENDAS.DESCONTO_COND_PGTO,0)- ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI))*100) ELSE 0 END 
PORC_DESCONTO_COND_PGTO_CALCULADO, CASE WHEN ISNULL(VENDAS.TOT_VALOR_ORIGINAL, 0) <> 0  AND VENDAS.TOT_VALOR_ORIGINAL-ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI > 0 THEN  
CONVERT(NUMERIC(14, 2), (ISNULL(VENDAS.RECARGO, 0)/(VENDAS.TOT_VALOR_ORIGINAL-ISNULL(VENDAS.RECARGO, 0)-VALOR_IPI))*100)  ELSE 0 END RECARGO,  ENTREGA_CIF , 
MATERIAIS.CLASSIF_FISCAL, CLASSIF_FISCAL.IPI AS CLASSIF_IPI,  MATERIAIS.TRIBUT_ORIGEM, MATERIAIS.TRIBUT_ICMS, VENDAS.MOEDA, VENDAS.PORCENTAGEM_ACERTO, 
VENDAS.PORC_DESCONTO,VENDAS.PORC_DESCONTO_BRUTO,VENDAS.PORC_DESCONTO_COND_PGTO,VENDAS.PORC_DESCONTO_DIGITADO,VENDAS.PORC_ENCARGO, VENDAS.NOME_CLIFOR_ENTREGA, 
ISNULL(MATERIAIS_INDICADOR_CFOP.INDICADOR_CFOP, CASE WHEN ISNULL(FILIAIS.INDICA_CFOP_SOMENTE_REVENDA, 0) = 1 AND MATERIAIS.INDICADOR_CFOP = 10 THEN 11 ELSE 
MATERIAIS.INDICADOR_CFOP END) INDICADOR_CFOP, DESCRICAO_INDICADOR_CFOP     , ESTOQUE_SAI1_MAT.QTDE AS QUANTIDADE, COD_TABELA_FILHA=''M'',  TRIBUT_ICMS.DESCRICAO AS 
TRIBUT_ICMS_DESCRICAO,  TRIBUT_ORIGEM.DESCRICAO AS TRIBUT_ORIGEM_DESCRICAO,  CLASSIF_FISCAL.DESC_CLASSIFICACAO, ESTOQUE_SAI1_MAT.VALOR_BRUTO AS TIMESTAMP, CONTA_CONTABIL = CASE 
WHEN @P1 = ''D'' OR @P2 = ''N'' THEN MATERIAIS.CONTA_CONTABIL_DEV_COMPRA WHEN @P3 = ''V'' OR @P4 = ''G'' THEN MATERIAIS.CONTA_CONTABIL_VENDA ELSE MATERIAIS.CONTA_CONTABIL END,  
CTB_CONTA_PLANO.DESC_CONTA,  FAIXA=''1'', GERAR_ITEM= CONVERT(BIT,1), ESTOQUE_SAI1_MAT.ITEM_IMPRESSAO , MATERIAIS.UNID_ESTOQUE AS UNIDADE, VENDAS.DESCONTO, VENDAS.RECARGO, 
VENDAS.ENCARGO  FROM (ESTOQUE_SAI1_MAT   LEFT JOIN VENDAS ON ESTOQUE_SAI1_MAT.PEDIDO = VENDAS.PEDIDO)    JOIN MATERIAIS ON ESTOQUE_SAI1_MAT.MATERIAL = MATERIAIS.MATERIAL    JOIN 
MATERIAIS_CORES ON ESTOQUE_SAI1_MAT.MATERIAL = MATERIAIS_CORES.MATERIAL AND ESTOQUE_SAI1_MAT.COR_MATERIAL = MATERIAIS_CORES.COR_MATERIAL    JOIN CLASSIF_FISCAL ON MATERIAIS.CLASSIF_FISCAL = CLASSIF_FISCAL.CLASSIF_FISCAL    JOIN FILIAIS ON ESTOQUE_SAI1_MAT.FILIAL = FILIAIS.FILIAL   LEFT JOIN VENDAS_MATERIAL ON ESTOQUE_SAI1_MAT.PEDIDO = VENDAS_MATERIAL.PEDIDO  AND ESTOQUE_SAI1_MAT.MATERIAL = VENDAS_MATERIAL.MATERIAL AND  ESTOQUE_SAI1_MAT.COR_MATERIAL = VENDAS_MATERIAL.COR_MATERIAL  LEFT JOIN TRIBUT_ICMS ON (MATERIAIS.TRIBUT_ICMS = TRIBUT_ICMS.TRIBUT_ICMS)   LEFT JOIN TRIBUT_ORIGEM ON (MATERIAIS.TRIBUT_ORIGEM = TRIBUT_ORIGEM.TRIBUT_ORIGEM)  LEFT JOIN CTB_CONTA_PLANO ON (CASE WHEN @P5 = ''D'' OR @P6 = ''N'' THEN MATERIAIS.CONTA_CONTABIL_DEV_COMPRA WHEN @P7 = ''V'' OR @P8 = ''G'' THEN MATERIAIS.CONTA_CONTABIL_VENDA ELSE MATERIAIS.CONTA_CONTABIL END = CTB_CONTA_PLANO.CONTA_CONTABIL)  LEFT JOIN COND_ATAC_PGTOS COND_ATAC_PGTOS ON (VENDAS.CONDICAO_PGTO=COND_ATAC_PGTOS.CONDICAO_PGTO)   JOIN FILIAIS FILIAL_FATURAMENTO ON FILIAL_FATURAMENTO.FILIAL = @P9 LEFT JOIN MATERIAIS_INDICADOR_CFOP ON MATERIAIS.MATERIAL = MATERIAIS_INDICADOR_CFOP.MATERIAL AND FILIAL_FATURAMENTO.FILIAL = MATERIAIS_INDICADOR_CFOP.FILIAL LEFT JOIN CTB_LX_INDICADOR_CFOP ON ISNULL(MATERIAIS_INDICADOR_CFOP.INDICADOR_CFOP, CASE WHEN ISNULL(FILIAIS.INDICA_CFOP_SOMENTE_REVENDA, 0) = 1 AND MATERIAIS.INDICADOR_CFOP = 10 THEN 11 ELSE MATERIAIS.INDICADOR_CFOP END) = CTB_LX_INDICADOR_CFOP.INDICADOR_CFOP  WHERE   estoque_sai1_mat.filial IN (SELECT FILIAL FROM FILIAIS WHERE MATRIZ_FISCAL = @P10)  and req_material = @P11  ORDER BY ESTOQUE_SAI1_MAT.FILIAL, ESTOQUE_SAI1_MAT.REQ_MATERIAL,  ESTOQUE_SAI1_MAT.MATERIAL, ESTOQUE_SAI1_MAT.COR_MATERIAL',N'@P1 varchar(1),@P2 varchar(1),@P3 varchar(1),@P4 varchar(1),@P5 varchar(1),@P6 varchar(1),@P7 varchar(1),@P8 varchar(1),@P9 varchar(9),@P10 varchar(9),@P11 varchar(6)','R','R','R','R','R','R','R','R','DR VAREJO','DR VAREJO','159565'


