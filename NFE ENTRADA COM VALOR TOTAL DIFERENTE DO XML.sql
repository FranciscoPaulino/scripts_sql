--- AJUSTA NFE JÁ IMPORTADAS
UPDATE A
SET A.NAO_SOMA_VALOR=1
--SELECT A.CODIGO_ITEM,C.CPROD,A.NAO_SOMA_VALOR 
FROM ENTRADAS_ITEM A WITH (NOLOCK)
JOIN ENTRADAS B WITH (NOLOCK) ON B.NF_ENTRADA=A.NF_ENTRADA AND B.SERIE_NF_ENTRADA=A.SERIE_NF_ENTRADA
JOIN XML_NFE_ITEM C WITH (NOLOCK) ON C.chNFe=B.CHAVE_NFE AND case when charindex('O.S.:',c.xProd) > 0 then substring(c.CPROD,9,12) else c.CPROD end=A.CODIGO_ITEM 
WHERE B.EMISSAO BETWEEN '20170801' AND '20170831' 
AND B.NATUREZA='230.01' 
AND C.indTot=0

SELECT A.NOME_CLIFOR, A.NF_ENTRADA,A.SERIE_NF_ENTRADA,A.VALOR_TOTAL,B.VPROD,C.VALOR_ITEM,A.QTDE_TOTAL,C.QTDE_ITEM
FROM ENTRADAS A
JOIN XML_NFE_TOTAL B ON B.CHNFE=A.CHAVE_NFE
JOIN (SELECT NOME_CLIFOR,NF_ENTRADA,SERIE_NF_ENTRADA,VALOR_ITEM=SUM(VALOR_ITEM),QTDE_ITEM=SUM(QTDE_ITEM) FROM ENTRADAS_ITEM WHERE NAO_SOMA_VALOR=0 GROUP BY NOME_CLIFOR,NF_ENTRADA,SERIE_NF_ENTRADA) C ON C.NOME_CLIFOR=A.NOME_CLIFOR AND C.NF_ENTRADA=A.NF_ENTRADA AND C.SERIE_NF_ENTRADA=A.SERIE_NF_ENTRADA
WHERE C.VALOR_ITEM <>B.VPROD OR C.QTDE_ITEM <> A.QTDE_TOTAL
ORDER BY A.NF_ENTRADA


-- ATUALIZAR VALOR E QTDE
UPDATE A
SET A.VALOR_TOTAL=B.VPROD,A.VALOR_SUB_ITENS=B.VPROD,A.QTDE_TOTAL=C.QTDE_ITEM
--SELECT A.NOME_CLIFOR, A.NF_ENTRADA,A.SERIE_NF_ENTRADA,A.VALOR_TOTAL,B.VPROD,C.VALOR_ITEM,A.QTDE_TOTAL,C.QTDE_ITEM
FROM ENTRADAS A
JOIN XML_NFE_TOTAL B ON B.CHNFE=A.CHAVE_NFE
JOIN (SELECT NOME_CLIFOR,NF_ENTRADA,SERIE_NF_ENTRADA,VALOR_ITEM=SUM(VALOR_ITEM),QTDE_ITEM=SUM(QTDE_ITEM) FROM ENTRADAS_ITEM WHERE NAO_SOMA_VALOR=0 GROUP BY NOME_CLIFOR,NF_ENTRADA,SERIE_NF_ENTRADA) C ON C.NOME_CLIFOR=A.NOME_CLIFOR AND C.NF_ENTRADA=A.NF_ENTRADA AND C.SERIE_NF_ENTRADA=A.SERIE_NF_ENTRADA
WHERE C.VALOR_ITEM <>B.VPROD OR C.QTDE_ITEM <> A.QTDE_TOTAL


SELECT A.NOME_CLIFOR, A.NF_ENTRADA,A.SERIE_NF_ENTRADA,A.VALOR_TOTAL,B.VPROD 
FROM ENTRADAS A
JOIN XML_NFE_TOTAL B ON B.CHNFE=A.CHAVE_NFE
WHERE A.VALOR_TOTAL<>B.VPROD  --and chnfe='23170811876530000114551040000058201839123048'
ORDER BY A.NF_ENTRADA


UPDATE A
SET A.VALOR_TOTAL=B.VPROD,A.VALOR_SUB_ITENS=B.VPROD
FROM ENTRADAS A
JOIN XML_NFE_TOTAL B ON B.CHNFE=A.CHAVE_NFE
WHERE A.VALOR_TOTAL<>B.VPROD  --and chnfe='23170811876530000114551040000058201839123048'

SELECT A.*
FROM ENTRADAS A
JOIN XML_NFE_TOTAL B ON B.CHNFE=A.CHAVE_NFE
WHERE A.VALOR_TOTAL<>B.VPROD  and chnfe='23170811876530000114551040000058201839123048'
ORDER BY A.NF_ENTRADA

SELECT * FROM NFE_XML
WHERE chAVE_nfe='23170811876530000114551040000058201839123048'


delete from entradas where serie_nf_entrada='1' and 
nf_entrada in ('0000742')        

SELECT 'EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '''+CHAVE_NFE+'''' FROM ENTRADAS
WHERE SERIE_NF_ENTRADA = '104' AND NF_ENTRADA IN(       
)        
		 
delete from entradas 
WHERE SERIE_NF_ENTRADA = '102' AND NF_ENTRADA IN(       
)        


select * from xml_nfe_item
where chnfe='23170811876530000114551040000058201839123048'




EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058201839123048'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058381540354120'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058401497693639'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058421850477087'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058511180768582'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058541506501461'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058621491037150'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058631738524362'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058641337111862'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058651954344533'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058701893576316'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058771962686848'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058781970725099'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058791960438140'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058821983524448'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058831970081787'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058871174237204'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058881029950660'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058891276926267'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000058971586994688'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059021939176957'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059031332688193'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059041017838351'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059051536843345'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059061862909695'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059071837146583'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059081363920663'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059091665300940'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059111464708142'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059121855103351'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059151089430573'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059161147327420'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059171941481420'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059181878093224'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059191459529543'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059201720516684'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059281736065391'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059291403540246'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059301479029187'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059311545956165'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059321675016178'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059331537980049'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059341171632155'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059351793530604'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059361165704055'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059371232759194'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059381240307156'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059391022463757'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059421406638290'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059431987194903'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059441097835848'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059451024567611'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059461720351223'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059511001464287'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059521341027344'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059531480001953'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059541168492871'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059551849311077'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059561076773232'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059571652779042'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059581661019290'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059591175353527'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059601614258044'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059611681160724'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059631987206866'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059641764906814'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059671492209223'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059681743011124'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059691070121118'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059701497233969'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059711104787103'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059721392382462'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059731228554172'
EXEC LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO '23170811876530000114551040000059741472388160'



ALTER PROCEDURE [dbo].[LX_IMPORTA_NFE_ENTRADA_OFICINA_ACERTO] @CHAVE_NFE VARCHAR(44) 
AS    
SET NOCOUNT OFF    
SET ANSI_WARNINGS ON    
    
DECLARE @MSG_XML AS XML,  @XML AS XML, @DTH_RECEBIMENTO AS VARCHAR(30),@TIPO_EMISSAO  VARCHAR(2), @STATUS AS INT,    
		@CNPJ_EMITENTE AS VARCHAR(14), @NUMERO_PROTOCOLO VARCHAR(15),@CNPJ_DESTINATARIO AS VARCHAR(14), @MOTIVO AS VARCHAR(500),      
		@ID_MSG AS INT, @MENSAGEM_ERRO AS VARCHAR(1000), @CONTINGENCIA VARCHAR(10), @CHAVE_NFE_DPEC  AS VARCHAR(44), @DHREGDPEC AS VARCHAR(24),    
		@NREGDPEC AS VARCHAR(15), @DH_CONTINGENCIA VARCHAR(24), @JUSTIFICATIVA VARCHAR(256), @AMBIENTE AS VARCHAR(1),   
		@RETORNO INT, @ID_PROCESSO INT, @ITEM_PROCESSO INT, @STATUS_PROCESSO TINYINT, @COD_LAYOUT_NFE AS SMALLINT, @ID_EDI_ARQUIVO AS INT,    
		@TIPO_DOC CHAR(2), @CMD VARCHAR(2000), @TABELA_STATUS VARCHAR(30), @FILIAL VARCHAR(25), @NF_SAIDA CHAR(7), @SERIE_NF CHAR(2), @ID_CAIXA_PGTO INT,    
		@GERA_FINANCEIRO BIT, @ERRMSG VARCHAR(8000), @XMLNAMESPACE AS BIT,  @IDDPEC VARCHAR(25), @ERRNO AS INT, 
		@STATUS_LINX INT, @NOME_CLIFOR VARCHAR(25), @CHAVE_NFE_LINX AS VARCHAR(44), @TIPO_MENSAGEM AS VARCHAR(1), @INFORMACAO_COMP as VARCHAR(MAX),  
		@EMAIL_NFE VARCHAR(60),@CNPJ_TRANSPORTADORA AS VARCHAR(14), @NUMERO_MODELO AS VARCHAR(3),          
		@NF_ENTRADA CHAR(15), @SERIE_NF_ENTRADA VARCHAR(6),	@NF_SAIDA_ENVIO CHAR(15) -- #2#

 
BEGIN     
    --- GRAVA OS DADOS NAS TABELAS ENTRADAS E ENTRADAS_ITEM E GERA IMPOSTOS E LANÇAMENTO CONTÁBIL
	--- entrada ordem de serviço
	---
	INSERT INTO ENTRADAS (
	NF_ENTRADA,                        
	NOME_CLIFOR,                       
	EMISSAO,                           
	FILIAL,                            
	EMPRESA,                           
	AGRUPAMENTO_ITENS,                 
	COD_TRANSACAO,                     
	NATUREZA,                          
	CONDICAO_PGTO,                     
	RECEBIMENTO,                       
	NF_FATURA,                         
	SERIE_NF_ENTRADA,                  
	TABELA_FILHA,                      
	TRANSF_FILIAL,                     
	TIPO_ENTRADAS,                     
	MOEDA,                             
	MOEDA_COMPRA,                      
	DATA_DIGITACAO,                    
	RATEIO_FILIAL,                     
	RATEIO_CENTRO_CUSTO,               
	DATA_FATURAMENTO_RELATIVO,         
	UTILIZA_DIAS_FIXOS_FORNECEDOR,     
	NOME_CLIFOR_TRIANGULAR,            
	SERIE_NF,                          
	NUMERO_ENTRADA,                    
	FATURA_NOME_CLIFOR,                
	FATURA_SERIE,                      
	FATURA_NUMERO,                     
	DIFERENCA_VALOR,                   
	QTDE_TOTAL,                        
	VALOR_TOTAL,                       
	FRETE_A_PAGAR,
	IMPORTACAO_IMPOSTO,                
	IMPORTACAO_ICMS,                   
	IMPORTACAO_IPI,                    
	IMPORTACAO_ALFANDEGA,              
	IMPORTACAO_OUTRAS_DESPESAS,        
	IMPORTACAO_FRETE,                  
	IMPORTACAO_SEGURO,                 
	IMPORTACAO_DESEMBARACO,            
	PORC_DESCONTO,                     
	PORC_ENCARGO,                      
	COMISSAO_VALOR,                    
	COMISSAO_VALOR_GERENTE,            
	VALOR_IMPOSTO_AGREGAR,             
	VALOR_SUB_ITENS,                   
	CAMBIO_NA_DATA,                    
	ESPECIE_SERIE,                     
	NOTA_CANCELADA,                    
	COD_CLIFOR_SACADO,                 
	IMPORTACAO_TX_CAPATAZIA,           
	CHAVE_NFE,
	PROTOCOLO_AUTORIZACAO_NFE,
	DATA_AUTORIZACAO_NFE,
	INFORMACAO_COMPLEMENTAR,
	TRANSPORTADORA_A_PAGAR)                          

	SELECT 
	REPLICATE(0, (7-LEN(RTRIM(A.nNF))))+RTRIM(A.nNF) AS NF_ENTRADA,                  
	C.NOME_CLIFOR,
	convert(date,A.dhEmi,103),
	D.NOME_CLIFOR,
	1,
	1,
	'ENTRADAS_108',
	F.NATUREZA_ENTRADA,
	'000',
	convert(date,A.dhSaiEnt,103),
	0,
	A.serie,
	'ENTRADAS_NF',
	0,
	F.TIPO_ENTRADAS,
	'R$',
	'R$',
	convert(date,GETDATE(),103),
	D.CLIFOR,
	F.RATEIO_CENTRO_CUSTO,
	NULL,
	0,
	C.NOME_CLIFOR,
	1,
	NULL,
	NULL,
	NULL,
	NULL,
	0,
	E.qTrib,
	E.vProd,
	1,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	E.vProd,
	1.000000,
	55,
	0,
	C.CLIFOR,
	0,
	A.chNFe,
	A.nProt,
	(A.dhRecbto-.125),
	A.infAdic,
	G.xNome
	FROM XML_NFE_CAPA A with (nolock)
	JOIN XML_NFE_TOTAL B with (nolock) ON B.chNFe=A.chNFe
	JOIN (SELECT DISTINCT CLIFOR,CGC_CPF,NOME_CLIFOR,RAZAO_SOCIAL FROM CADASTRO_CLI_FOR N with (nolock) JOIN PARAMETROS_IMPORT_XML X with (nolock) ON X.COD_CLIFOR_SACADO=N.CLIFOR) C ON C.CGC_CPF=A.emit_CNPJ
	JOIN (SELECT DISTINCT CLIFOR,CGC_CPF,NOME_CLIFOR,RAZAO_SOCIAL FROM CADASTRO_CLI_FOR N with (nolock) JOIN PARAMETROS_IMPORT_XML X with (nolock) ON X.RATEIO_FILIAL=N.CLIFOR) D ON D.CGC_CPF=A.dest_CNPJ
	JOIN (SELECT chNfe, qTrib=SUM(qTrib),vProd=SUM(vProd) FROM XML_NFE_ITEM with (nolock) where indTot=1 GROUP BY chNfe) E ON E.chNFe=A.chNFe
	JOIN (SELECT DISTINCT NATOP,NATUREZA_ENTRADA,TIPO_ENTRADAS,RATEIO_CENTRO_CUSTO FROM PARAMETROS_IMPORT_XML with (nolock)) F ON F.natop=a.natOp 
	LEFT JOIN XML_NFE_TRANSPORTADOR G with (nolock) ON G.chNFe=A.chNFe
	where a.chNFe=@CHAVE_NFE
	AND NOT EXISTS(SELECT * FROM ENTRADAS with (nolock) WHERE CHAVE_NFE=A.CHNFE)

	--- ENTRADAS_ITEM
	INSERT INTO ENTRADAS_ITEM(
	NOME_CLIFOR,                                
	NF_ENTRADA,                                 
	SERIE_NF_ENTRADA,                           
	ITEM_IMPRESSAO,                             
	SUB_ITEM_TAMANHO,                           
	DESCRICAO_ITEM,                             
	QTDE_ITEM,                                  
	PRECO_UNITARIO,                             
	CODIGO_ITEM,                                
	DESCONTO_ITEM,                              
	VALOR_ITEM,                                 
	COD_TABELA_FILHA,                           
	TRIBUT_ICMS,                                
	TRIBUT_ORIGEM,                              
	UNIDADE,                                    
	CLASSIF_FISCAL,                             
	CODIGO_FISCAL_OPERACAO,                     
	PESO,                                       
	CONTA_CONTABIL,                             
	QTDE_RETORNAR_BENEFICIAMENTO,               
	FAIXA,                                      
	COMISSAO_ITEM,                              
	COMISSAO_ITEM_GERENTE,                      
	INDICADOR_CFOP,                             
	QTDE_DEVOLVIDA,                             
	PORCENTAGEM_ITEM_RATEIO,                    
	ID_EXCECAO_IMPOSTO,                         
	REFERENCIA,                                 
	REFERENCIA_ITEM,                            
	REFERENCIA_PEDIDO,                          
	VALOR_ENCARGOS,                             
	VALOR_DESCONTOS,                            
	NAO_SOMA_VALOR,                             
	VALOR_ENCARGOS_IMPORTACAO,                  
	RATEIO_FILIAL,                              
	RATEIO_CENTRO_CUSTO,                        
	VALOR_ENCARGOS_ADUANEIROS,                  
	PORC_ITEM_RATEIO_FRETE,                     
	ITEM_NFE,                                   
	MPADRAO_SEGURO_ITEM,                        
	MPADRAO_FRETE_ITEM,                         
	MPADRAO_ENCARGO_ITEM,                       
	ORIGEM_ITEM,
	PRECO_UNITARIO_ORIGINAL)

	SELECT 
	C.NOME_CLIFOR,
	REPLICATE(0, (7-LEN(RTRIM(B.nNF))))+RTRIM(B.nNF) AS NF_ENTRADA,
	B.SERIE,
	REPLICATE(0, (4-LEN(RTRIM(A.nItem))))+RTRIM(A.nItem) AS  nItem,
	0,
	case when charindex('O.S.:',A.xProd) > 0 then substring(A.XPROD,1,charindex('O.S.:',A.xProd)-1) else A.XPROD end,
	A.QTRIB,
	A.VUNTRIB,
	case when charindex('O.S.:',A.xProd) > 0 then substring(A.CPROD,9,12) else A.CPROD end,
	0,
	A.VPROD,
	'R',
	F.TRIBUT_ICMS,
	ISNULL(F.TRIBUT_ORIGEM,0),
	A.UCOM,
	A.NCM,
	I.CODIGO_FISCAL_OPERACAO,
	0,
	J.CONTA_CONTABIL,
	0,
	'1',
	0,
	0,
	J.INDICADOR_CFOP,
	0,
	((A.QTRIB*A.VUNTRIB)/E.vProd)*100,
	F.ID_EXCECAO_IMPOSTO,
	case when charindex('O.S.:',A.xProd) > 0 then substring(A.CPROD,9,12) else A.CPROD end,
	case when charindex('O.S.:',A.xProd) > 0 then substring(A.CPROD,9,12) else A.CPROD end,
	NULL,
	0,
	0,
	CASE WHEN A.INDTOT=0 THEN 1 ELSE 0 END,
	0,
	D.CLIFOR,
	I.RATEIO_CENTRO_CUSTO,
	0,
	((A.QTRIB*A.VUNTRIB)/E.vProd)*100,
	A.NITEM,
	0,
	0,
	0,
	J.ORIGEM_ITEM,
	A.VUNTRIB	
	FROM XML_NFE_ITEM A with (nolock)
	JOIN XML_NFE_CAPA B with (nolock) ON B.chNFe=A.chNFe
	JOIN (SELECT DISTINCT CLIFOR,CGC_CPF,NOME_CLIFOR,RAZAO_SOCIAL FROM CADASTRO_CLI_FOR N with (nolock) JOIN PARAMETROS_IMPORT_XML X with (nolock) ON X.COD_CLIFOR_SACADO=N.CLIFOR) C ON C.CGC_CPF=B.emit_CNPJ
	JOIN (SELECT DISTINCT CLIFOR,CGC_CPF,NOME_CLIFOR,RAZAO_SOCIAL FROM CADASTRO_CLI_FOR N with (nolock) JOIN PARAMETROS_IMPORT_XML X with (nolock) ON X.RATEIO_FILIAL=N.CLIFOR) D ON D.CGC_CPF=B.dest_CNPJ
	JOIN (SELECT chNfe, qTrib=SUM(qTrib),vProd=SUM(vProd) FROM XML_NFE_ITEM with (nolock) where indTot=1 GROUP BY chNfe) E ON E.chNFe=A.chNFe
	JOIN (SELECT A.*,B.NATOP FROM CTB_EXCECAO_IMPOSTO A with (nolock) JOIN (SELECT DISTINCT NATOP,NATUREZA_ENTRADA FROM PARAMETROS_IMPORT_XML with (nolock)) B ON B.NATUREZA_ENTRADA=A.NATUREZA_ENTRADA WHERE A.INATIVO=0) F ON F.NATOP=B.NATOP
	JOIN (SELECT DISTINCT NATOP,NATUREZA_ENTRADA,TIPO_ENTRADAS,RATEIO_CENTRO_CUSTO,CODIGO_FISCAL_OPERACAO FROM PARAMETROS_IMPORT_XML with (nolock)) I ON I.natop=B.natOp 
	LEFT JOIN IMPORT_XML_NFE_REFERENCIAS_ORIGEM_ITEM J with (nolock) ON J.REFERENCIA=case when charindex('O.S.:',A.xProd) > 0 then substring(A.CPROD,9,12) else A.CPROD end
	where a.chNFe=@CHAVE_NFE
	AND NOT EXISTS(SELECT * FROM ENTRADAS_ITEM with (nolock) WHERE NF_ENTRADA=REPLICATE(0, (7-LEN(RTRIM(B.nNF))))+RTRIM(B.nNF) AND CODIGO_ITEM=A.CPROD AND SERIE_NF_ENTRADA=B.serie AND NOME_CLIFOR=C.NOME_CLIFOR)

	SELECT @NF_ENTRADA = NF_ENTRADA FROM ENTRADAS WHERE CHAVE_NFE=@CHAVE_NFE
	SELECT @SERIE_NF_ENTRADA = SERIE_NF_ENTRADA FROM ENTRADAS WHERE CHAVE_NFE=@CHAVE_NFE
	SELECT @NOME_CLIFOR = NOME_CLIFOR FROM ENTRADAS WHERE CHAVE_NFE=@CHAVE_NFE

	--- GERA IMPOSTOS ENTRADA
	EXEC LX_GERA_IMPOSTOS_ENTRADA @NOME_CLIFOR,@NF_ENTRADA,@SERIE_NF_ENTRADA,1,1,1

	--- GERA INTEGRAÇÃO 
	EXEC LX_CTB_Integrar_Entrada @NOME_CLIFOR,@NF_ENTRADA,@SERIE_NF_ENTRADA

	--- BUSCA NFE DE SAIDA ENVIO PARA OFICINA
	SELECT @NF_SAIDA_ENVIO = case when charindex('NF:',A.xProd) > 0 then substring(A.xProd,charindex('NF:',A.xProd)+3,10) else '' end 
	FROM XML_NFE_ITEM A with (nolock)
	JOIN XML_NFE_CAPA B with (nolock) ON B.chNFe=A.chNFe
	JOIN (SELECT DISTINCT CLIFOR,CGC_CPF,NOME_CLIFOR,RAZAO_SOCIAL FROM CADASTRO_CLI_FOR N with (nolock) JOIN PARAMETROS_IMPORT_XML X with (nolock) ON X.COD_CLIFOR_SACADO=N.CLIFOR) C ON C.CGC_CPF=B.emit_CNPJ
	JOIN (SELECT DISTINCT CLIFOR,CGC_CPF,NOME_CLIFOR,RAZAO_SOCIAL FROM CADASTRO_CLI_FOR N with (nolock) JOIN PARAMETROS_IMPORT_XML X with (nolock) ON X.RATEIO_FILIAL=N.CLIFOR) D ON D.CGC_CPF=B.dest_CNPJ
	JOIN (SELECT chNfe, qTrib=SUM(qTrib),vProd=SUM(vProd) FROM XML_NFE_ITEM with (nolock) where indTot=1 GROUP BY chNfe) E ON E.chNFe=A.chNFe
	JOIN (SELECT A.*,B.NATOP FROM CTB_EXCECAO_IMPOSTO A with (nolock) JOIN (SELECT DISTINCT NATOP,NATUREZA_ENTRADA FROM PARAMETROS_IMPORT_XML with (nolock)) B ON B.NATUREZA_ENTRADA=A.NATUREZA_ENTRADA WHERE A.INATIVO=0) F ON F.NATOP=B.NATOP
	JOIN (SELECT DISTINCT NATOP FROM PARAMETROS_IMPORT_XML with (nolock)) I ON I.natop=B.natOp 
	LEFT JOIN IMPORT_XML_NFE_REFERENCIAS_ORIGEM_ITEM J with (nolock) ON J.REFERENCIA=case when charindex('O.S.:',A.xProd) > 0 then substring(A.CPROD,9,12) else A.CPROD end
	where a.chNFe=@CHAVE_NFE AND XPROD LIKE '%NF:%'

	--- GERA A TABELA TEMPORARIA PARA BUSCAR ITEM DE NFE SAIDA ORIGEM 
	SELECT [CLASSIF_FISCAL],[CODIGO_FISCAL_OPERACAO],[CODIGO_ITEM],[COD_TABELA_FILHA],[COMISSAO_ITEM]
		  ,[COMISSAO_ITEM_GERENTE],[CONTA_CONTABIL],[DESCONTO_ITEM],[DESCRICAO_ITEM],[FAIXA],[FILIAL]
		  ,[ID_EXCECAO_IMPOSTO],[INDICADOR_CFOP],[ITEM_IMPRESSAO],[MPADRAO_DESCONTO_ITEM],[MPADRAO_PRECO_UNITARIO]
		  ,[MPADRAO_VALOR_ITEM],[NF_SAIDA],[PESO],[PORCENTAGEM_ITEM_RATEIO],[PRECO_UNITARIO],[QTDE_DEVOLVIDA]
		  ,[QTDE_ITEM],[QTDE_RETORNAR_BENEFICIAMENTO],[SERIE_NF],[SUB_ITEM_TAMANHO],[TRIBUT_ICMS]
		  ,[TRIBUT_ORIGEM],[UNIDADE],[VALOR_ITEM],[REFERENCIA],[REFERENCIA_ITEM],[REFERENCIA_PEDIDO]
		  ,[MPADRAO_VALOR_DESCONTOS],[MPADRAO_VALOR_ENCARGOS],[NAO_SOMA_VALOR],[OBS_ITEM],[ITEM_NFE]
		  ,[MPADRAO_SEGURO_ITEM],[MPADRAO_FRETE_ITEM],[MPADRAO_ENCARGO_ITEM],[RATEIO_FILIAL],[RATEIO_CENTRO_CUSTO]
		  ,[ORIGEM_ITEM],[VALOR_IMPOSTO_ITEM],[INDICA_PRODUTO_PROCESSO],[CODIGO_FCI],[PRECO_UNITARIO_ORIGINAL]
		  ,[CTB_TIPO_OPERACAO],[ID_SUB_PROJETO],[VALOR_IMPOSTO_ITEM_MUNICIPAL],[VALOR_IMPOSTO_ITEM_ESTADUAL],[ID_CEST_NCM]
	INTO #FATURAMENTO_ITEM_ORIGEM 
	FROM FATURAMENTO_ITEM WITH (NOLOCK)
	WHERE NF_SAIDA=@NF_SAIDA_ENVIO AND  SERIE_NF = '56'
   
	--- ENTRADA_ITEM_RELACIONADO
	--- ITEM COM NF SAIDA E COD_TABELA_FILHA = 'M'
	INSERT INTO ENTRADA_ITEM_RELACIONADO ([ITEM_RELACIONADO],[QTDE_RELACIONADA],[VALOR_RELACIONADO]
		  ,[FAT_FILIAL],[FAT_NF_SAIDA],[FAT_SERIE_NF],[FAT_ITEM_IMPRESSAO],[FAT_SUB_ITEM_TAMANHO]
		  ,[QTDE_PERDA_PROCESSO],[QTDE_NAO_BENEFICIADA],[CODIGO_FISCAL_OPERACAO]
		  ,[ENT_NOME_CLIFOR],[ENT_NF_ENTRADA],[ENT_SERIE_NF_ENTRADA],[ENT_ITEM_IMPRESSAO]
		  ,[ENT_SUB_ITEM_TAMANHO],[NF_ENTRADA],[NOME_CLIFOR],[SERIE_NF_ENTRADA]
		  ,[ITEM_IMPRESSAO],[TIPO_ITEM_RELACIONADO],[SUB_ITEM_TAMANHO],[ITEM_COMPOSICAO],[NATUREZA])
	SELECT L.ITEM_IMPRESSAO,A.QTRIB,A.VPROD,L.FILIAL,L.NF_SAIDA
		  ,L.SERIE_NF,L.ITEM_IMPRESSAO,L.SUB_ITEM_TAMANHO,0 AS QTDE_PERDA_PROCESSO
		  ,0 AS QTDE_NAO_BENEFICIADA,I.CODIGO_FISCAL_OPERACAO,NULL AS ENT_NOME_CLIFOR, NULL AS ENT_NF_ENTRADA
		  ,NULL AS ENT_SERIE_NF_ENTRADA,NULL AS ENT_ITEM_IMPRESSAO,NULL AS ENT_SUB_ITEM_TAMANHO
		  ,REPLICATE(0, (7-LEN(RTRIM(B.nNF))))+RTRIM(B.nNF) AS NF_ENTRADA
		  ,C.NOME_CLIFOR,B.SERIE AS SERIE_NF_ENTRADA,L.ITEM_IMPRESSAO AS ITEM_IMPRESSAO,0 AS TIPO_ITEM_RELACIONADO
		  ,0 AS SUB_ITEM_TAMANHO,'304' AS ITEM_COMPOSICAO,I.NATUREZA_ENTRADA AS NATUREZA 
	FROM (  SELECT [chNFe],[cProd],[cEAN],[xProd],[NCM],[CFOP],[uCom],[vUnCom],[cEANTrib],[uTrib],[vUnTrib]
				  ,[indTot],[infAdProd],[vTotTrib],[ICMS_orig],[ICMS_CST],[ICMS_modBC],[ICMS_vBC],[ICMS_pICMS],[ICMS_vICMS],[IPI_cEnq]
				  ,[IPI_CST],[IPI_vBC],[IPI_pIPI],[IPI_vIPI],[PIS_CST],[PIS_vBC],[PIS_pPIS],[PIS_vPIS],[COFINS_CST],[COFINS_vBC],[COFINS_pCOFINS]
				  ,[COFINS_vCOFINS],[qCom]=SUM([qCom]),[vProd]=SUM([vProd]),[qTrib]=SUM([qTrib])
			FROM XML_NFE_ITEM with (nolock)
			where chNFe=@CHAVE_NFE
			GROUP BY [chNFe],[cProd],[cEAN],[xProd],[NCM],[CFOP],[uCom],[vUnCom],[cEANTrib],[uTrib],[vUnTrib]
				  ,[indTot],[infAdProd],[vTotTrib],[ICMS_orig],[ICMS_CST],[ICMS_modBC],[ICMS_vBC],[ICMS_pICMS],[ICMS_vICMS],[IPI_cEnq]
				  ,[IPI_CST],[IPI_vBC],[IPI_pIPI],[IPI_vIPI],[PIS_CST],[PIS_vBC],[PIS_pPIS],[PIS_vPIS],[COFINS_CST],[COFINS_vBC],[COFINS_pCOFINS]
				  ,[COFINS_vCOFINS]	
	) A
	JOIN XML_NFE_CAPA B with (nolock) ON B.chNFe=A.chNFe
	JOIN (SELECT DISTINCT CLIFOR,CGC_CPF,NOME_CLIFOR,RAZAO_SOCIAL FROM CADASTRO_CLI_FOR N with (nolock) JOIN PARAMETROS_IMPORT_XML X with (nolock) ON X.COD_CLIFOR_SACADO=N.CLIFOR) C ON C.CGC_CPF=B.emit_CNPJ
	JOIN (SELECT DISTINCT CLIFOR,CGC_CPF,NOME_CLIFOR,RAZAO_SOCIAL FROM CADASTRO_CLI_FOR N with (nolock) JOIN PARAMETROS_IMPORT_XML X with (nolock) ON X.RATEIO_FILIAL=N.CLIFOR) D ON D.CGC_CPF=B.dest_CNPJ
	JOIN (SELECT chNfe, qTrib=SUM(qTrib),vProd=SUM(vProd) FROM XML_NFE_ITEM with (nolock) where indTot=1 GROUP BY chNfe) E ON E.chNFe=A.chNFe
	JOIN (SELECT A.*,B.NATOP FROM CTB_EXCECAO_IMPOSTO A with (nolock) JOIN (SELECT DISTINCT NATOP,NATUREZA_ENTRADA FROM PARAMETROS_IMPORT_XML with (nolock)) B ON B.NATUREZA_ENTRADA=A.NATUREZA_ENTRADA WHERE A.INATIVO=0) F ON F.NATOP=B.NATOP
	JOIN (SELECT DISTINCT NATOP,NATUREZA_ENTRADA,TIPO_ENTRADAS,RATEIO_CENTRO_CUSTO,CODIGO_FISCAL_OPERACAO FROM PARAMETROS_IMPORT_XML with (nolock)) I ON I.natop=B.natOp 
	LEFT JOIN IMPORT_XML_NFE_REFERENCIAS_ORIGEM_ITEM J with (nolock) ON J.REFERENCIA=case when charindex('O.S.:',A.xProd) > 0 then substring(A.CPROD,9,12) else A.CPROD end
	LEFT JOIN #FATURAMENTO_ITEM_ORIGEM L ON L.CODIGO_ITEM=A.CPROD
	where a.chNFe=@CHAVE_NFE AND L.COD_TABELA_FILHA='M'

	--- ENTRADA_ITEM_RELACIONADO
	--- ITEM COM NF SAIDA E COD_TABELA_FILHA = 'O'
	INSERT INTO ENTRADA_ITEM_RELACIONADO ([ITEM_RELACIONADO],[QTDE_RELACIONADA],[VALOR_RELACIONADO]
		  ,[FAT_FILIAL],[FAT_NF_SAIDA],[FAT_SERIE_NF],[FAT_ITEM_IMPRESSAO],[FAT_SUB_ITEM_TAMANHO]
		  ,[QTDE_PERDA_PROCESSO],[QTDE_NAO_BENEFICIADA],[CODIGO_FISCAL_OPERACAO]
		  ,[ENT_NOME_CLIFOR],[ENT_NF_ENTRADA],[ENT_SERIE_NF_ENTRADA],[ENT_ITEM_IMPRESSAO]
		  ,[ENT_SUB_ITEM_TAMANHO],[NF_ENTRADA],[NOME_CLIFOR],[SERIE_NF_ENTRADA]
		  ,[ITEM_IMPRESSAO],[TIPO_ITEM_RELACIONADO],[SUB_ITEM_TAMANHO],[ITEM_COMPOSICAO],[NATUREZA])
	SELECT L.ITEM_IMPRESSAO,A.QTRIB,A.VPROD,L.FILIAL,L.NF_SAIDA
		  ,L.SERIE_NF,L.ITEM_IMPRESSAO,L.SUB_ITEM_TAMANHO,0 AS QTDE_PERDA_PROCESSO
		  ,0 AS QTDE_NAO_BENEFICIADA,I.CODIGO_FISCAL_OPERACAO,NULL AS ENT_NOME_CLIFOR, NULL AS ENT_NF_ENTRADA
		  ,NULL AS ENT_SERIE_NF_ENTRADA,NULL AS ENT_ITEM_IMPRESSAO,NULL AS ENT_SUB_ITEM_TAMANHO
		  ,REPLICATE(0, (7-LEN(RTRIM(B.nNF))))+RTRIM(B.nNF) AS NF_ENTRADA
		  ,C.NOME_CLIFOR,B.SERIE AS SERIE_NF_ENTRADA,L.ITEM_IMPRESSAO AS ITEM_IMPRESSAO,0 AS TIPO_ITEM_RELACIONADO
		  ,0 AS SUB_ITEM_TAMANHO,'304' AS ITEM_COMPOSICAO,I.NATUREZA_ENTRADA AS NATUREZA 
	FROM (  SELECT [chNFe],[cProd],[cEAN],[xProd],[NCM],[CFOP],[uCom],[vUnCom],[cEANTrib],[uTrib],[vUnTrib]
				  ,[indTot],[infAdProd],[vTotTrib],[ICMS_orig],[ICMS_CST],[ICMS_modBC],[ICMS_vBC],[ICMS_pICMS],[ICMS_vICMS],[IPI_cEnq]
				  ,[IPI_CST],[IPI_vBC],[IPI_pIPI],[IPI_vIPI],[PIS_CST],[PIS_vBC],[PIS_pPIS],[PIS_vPIS],[COFINS_CST],[COFINS_vBC],[COFINS_pCOFINS]
				  ,[COFINS_vCOFINS],[qCom]=SUM([qCom]),[vProd]=SUM([vProd]),[qTrib]=SUM([qTrib])
			FROM XML_NFE_ITEM with (nolock)
			where chNFe=@CHAVE_NFE
			GROUP BY [chNFe],[cProd],[cEAN],[xProd],[NCM],[CFOP],[uCom],[vUnCom],[cEANTrib],[uTrib],[vUnTrib]
				  ,[indTot],[infAdProd],[vTotTrib],[ICMS_orig],[ICMS_CST],[ICMS_modBC],[ICMS_vBC],[ICMS_pICMS],[ICMS_vICMS],[IPI_cEnq]
				  ,[IPI_CST],[IPI_vBC],[IPI_pIPI],[IPI_vIPI],[PIS_CST],[PIS_vBC],[PIS_pPIS],[PIS_vPIS],[COFINS_CST],[COFINS_vBC],[COFINS_pCOFINS]
				  ,[COFINS_vCOFINS]		
	) A
	JOIN XML_NFE_CAPA B with (nolock) ON B.chNFe=A.chNFe
	JOIN (SELECT DISTINCT CLIFOR,CGC_CPF,NOME_CLIFOR,RAZAO_SOCIAL FROM CADASTRO_CLI_FOR N with (nolock) JOIN PARAMETROS_IMPORT_XML X with (nolock) ON X.COD_CLIFOR_SACADO=N.CLIFOR) C ON C.CGC_CPF=B.emit_CNPJ
	JOIN (SELECT DISTINCT CLIFOR,CGC_CPF,NOME_CLIFOR,RAZAO_SOCIAL FROM CADASTRO_CLI_FOR N with (nolock) JOIN PARAMETROS_IMPORT_XML X with (nolock) ON X.RATEIO_FILIAL=N.CLIFOR) D ON D.CGC_CPF=B.dest_CNPJ
	JOIN (SELECT chNfe, qTrib=SUM(qTrib),vProd=SUM(vProd) FROM XML_NFE_ITEM with (nolock) where indTot=1 GROUP BY chNfe) E ON E.chNFe=A.chNFe
	JOIN (SELECT A.*,B.NATOP FROM CTB_EXCECAO_IMPOSTO A with (nolock) JOIN (SELECT DISTINCT NATOP,NATUREZA_ENTRADA FROM PARAMETROS_IMPORT_XML with (nolock)) B ON B.NATUREZA_ENTRADA=A.NATUREZA_ENTRADA WHERE A.INATIVO=0) F ON F.NATOP=B.NATOP
	JOIN (SELECT DISTINCT NATOP,NATUREZA_ENTRADA,TIPO_ENTRADAS,RATEIO_CENTRO_CUSTO,CODIGO_FISCAL_OPERACAO FROM PARAMETROS_IMPORT_XML with (nolock)) I ON I.natop=B.natOp 
	LEFT JOIN IMPORT_XML_NFE_REFERENCIAS_ORIGEM_ITEM J with (nolock) ON J.REFERENCIA=case when charindex('O.S.:',A.xProd) > 0 then substring(A.CPROD,9,12) else A.CPROD end
	LEFT JOIN #FATURAMENTO_ITEM_ORIGEM L ON RTRIM(SUBSTRING(L.CODIGO_ITEM,9,12))=RTRIM(SUBSTRING(A.CPROD,9,12))
	where a.chNFe=@CHAVE_NFE AND L.COD_TABELA_FILHA='O'

	DROP TABLE #FATURAMENTO_ITEM_ORIGEM
END 

