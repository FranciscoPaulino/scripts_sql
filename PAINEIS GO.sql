declare @RECURSO_PRODUTIVO char(10)
set @RECURSO_PRODUTIVO='ELM02'

SELECT 
DESC_SETOR_PRODUCAO,  
DESC_RECURSO,  
RECURSO_PRODUTIVO,  
QTDE_OPERADOR=ISNULL(QTDE_OPERADOR,0),  
MINUTOS_DISPONIVEIS=ISNULL(MINUTOS_DISPONIVEIS,0),  
DIA,
BH=CASE 
WHEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,16) BETWEEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '00:00' AND SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '09:15'
THEN '1ª'
WHEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,16) BETWEEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '09:16' AND SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '11:30'
THEN '2ª'
WHEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,16) BETWEEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '11:31' AND SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '14:45'
THEN '3ª'
WHEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,16) BETWEEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '14:46' AND SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '23:59'
THEN '4ª'
END,
META_BH = ISNULL(CASE 
WHEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,16) BETWEEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '00:00' AND SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '09:15'
THEN CONVERT(NUMERIC(6,0),(MINUTOS_DISPONIVEIS*QTDE_OPERADOR)/(SUM(TEMPO_CRONOMETRADO*QTDE_S)/SUM(QTDE_S))/4)
WHEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,16) BETWEEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '09:16' AND SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '11:30'
THEN CONVERT(NUMERIC(6,0),(CONVERT(NUMERIC(6,0),(MINUTOS_DISPONIVEIS*QTDE_OPERADOR)/(SUM(TEMPO_CRONOMETRADO*QTDE_S)/SUM(QTDE_S))) - ISNULL(DBO.QTDE_BI_HORARIA_NOVA(@RECURSO_PRODUTIVO,SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '00:00',SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '09:15'),0))/3) 
WHEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,16) BETWEEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '11:31' AND SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '14:45'
THEN CONVERT(NUMERIC(6,0),(CONVERT(NUMERIC(6,0),(MINUTOS_DISPONIVEIS*QTDE_OPERADOR)/(SUM(TEMPO_CRONOMETRADO*QTDE_S)/SUM(QTDE_S))) - ISNULL(DBO.QTDE_BI_HORARIA_NOVA(@RECURSO_PRODUTIVO,SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '00:00',SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '11:30'),0))/2) 
WHEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,16) BETWEEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '14:46' AND SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '23:59'
THEN CONVERT(NUMERIC(6,0),(CONVERT(NUMERIC(6,0),(MINUTOS_DISPONIVEIS*QTDE_OPERADOR)/(SUM(TEMPO_CRONOMETRADO*QTDE_S)/SUM(QTDE_S))) - ISNULL(DBO.QTDE_BI_HORARIA_NOVA(@RECURSO_PRODUTIVO,SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '00:00',SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '14:45'),0))/1) 
END,0),
REALIZADO_BH = ISNULL(CASE 
WHEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,16) BETWEEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '00:00' AND SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '09:15'
THEN ISNULL(DBO.QTDE_BI_HORARIA_NOVA(@RECURSO_PRODUTIVO,SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '00:00',SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '09:15'),0)
WHEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,16) BETWEEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '09:16' AND SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '11:30'
THEN ISNULL(DBO.QTDE_BI_HORARIA_NOVA(@RECURSO_PRODUTIVO,SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '09:16',SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '11:30'),0)
WHEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,16) BETWEEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '11:31' AND SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '14:45'
THEN ISNULL(DBO.QTDE_BI_HORARIA_NOVA(@RECURSO_PRODUTIVO,SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '11:31',SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '14:45'),0)
WHEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,16) BETWEEN SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '14:46' AND SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '23:59'
THEN ISNULL(DBO.QTDE_BI_HORARIA_NOVA(@RECURSO_PRODUTIVO,SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '14:46',SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '23:59'),0)
END,0),
REALIZADO_TOTAL=ISNULL(DBO.QTDE_BI_HORARIA_NOVA(@RECURSO_PRODUTIVO,SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '00:00',SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '23:59'),0),
META=ISNULL(CONVERT(NUMERIC(6,0),(MINUTOS_DISPONIVEIS*QTDE_OPERADOR)/(SUM(TEMPO_CRONOMETRADO*QTDE_S)/SUM(QTDE_S))),0),
EFICIENCIA=ISNULL(CONVERT(NUMERIC(6,0),(ISNULL(DBO.QTDE_BI_HORARIA_NOVA(@RECURSO_PRODUTIVO,SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '00:00',SUBSTRING(CONVERT(VARCHAR(40),GETDATE(),21),1,11) + '23:59'),0)/CONVERT(NUMERIC(6,0),(MINUTOS_DISPONIVEIS*QTDE_OPERADOR)/(SUM(TEMPO_CRONOMETRADO*QTDE_S)/SUM(QTDE_S))))*100),0)
FROM W_SAW_META_DIA
WHERE RECURSO_PRODUTIVO = @RECURSO_PRODUTIVO
GROUP BY
DESC_SETOR_PRODUCAO,  
DESC_RECURSO,  
RECURSO_PRODUTIVO,  
QTDE_OPERADOR,  
MINUTOS_DISPONIVEIS,  
DIA  


