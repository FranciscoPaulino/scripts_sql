Text
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE trigger [dbo].[LDR_TI_VENDAS_LOTE] on [dbo].[VENDAS_LOTE] for INSERT NOT FOR REPLICATION as
/* INSERT trigger on VENDAS_LOTE */
begin
  declare  @numrows int,
           @nullcnt int,
           @validcnt int,
           @insPEDIDO_EXTERNO char(12),
		   @numeroParcelas int,
		   @condicaoPgto char(3),
           @tot_valor_liquido numeric(14,2),
           @valor_minimo_parcela int,
		   @qtde_pecas int,           
           @errno   int,
           @errmsg  varchar(255)

  select @numrows = @@rowcount
  /* PRODUTOS_PERIODOS_ENTREGAS R/832 VENDAS_LOTE ON CHILD INSERT RESTRICT */
  if 
     update(NUMERO_ENTREGA) OR update(PERIODO_PCP)
  begin
    select @nullcnt = 0
    select @validcnt = count(*)
      from inserted,PRODUTOS_PERIODOS_ENTREGAS
     where 
           inserted.NUMERO_ENTREGA = PRODUTOS_PERIODOS_ENTREGAS.NUMERO_ENTREGA AND
           inserted.PERIODO_PCP = PRODUTOS_PERIODOS_ENTREGAS.PERIODO_PCP 
    
    if @validcnt + @nullcnt != @numrows
    begin
      select @errno  = 30002,
             @errmsg = 'Impossível Incluir #VENDAS_LOTE #porque #PRODUTOS_PERIODOS_ENTREGAS #não existe.'
      goto error
    end
  end
  
  /* Verifica limite de parcela da condição de pagamento*/
  if UPDATE(CONDICAO_PGTO)
  BEGIN   
     -- Busca números de parcelas e valor líquido do pedido
     SELECT @condicaoPgto=rtrim(A.CONDICAO_PGTO),@qtde_pecas=B.TOT_QTDE_ORIGINAL,@numeroParcelas=A.NUMERO_PARCELAS,@tot_valor_liquido=(B.TOT_VALOR_ORIGINAL-b.DESCONTO) 
     FROM FORMA_PGTO A 
     JOIN inserted B ON B.CONDICAO_PGTO=A.CONDICAO_PGTO
     WHERE A.TIPO_CONDICAO<>'VISTA'

     -- Busca valor mínimo de parcela 
     SELECT @valor_minimo_parcela = VALOR_ATUAL FROM PARAMETROS WHERE PARAMETRO='VLR_MINIMO_PARCELA_VENDAS'
     
     -- Verifica valor da parcela
     if (@tot_valor_liquido / @numeroParcelas) < @valor_minimo_parcela
     BEGIN
      select @errno  = 30002,
             @errmsg = 'Impossível Incluir #VENDAS_LOTE# porque o #VALOR DA PARCELA#('+RTRIM(CAST(CAST((@tot_valor_liquido / @numeroParcelas) AS numeric(14,2)) AS CHAR(20)))+') é menor que valor mínimo permitido ('+RTRIM(CAST(@valor_minimo_parcela as char
(20)))+').'
      goto error
     END     

     -- Verifica TOT_QTDE_ORIGINAL x CONDIÇÃO DE PAGAMENTO
     if (@condicaoPgto in ('AL','BZ','BN') AND @qtde_pecas < 300)
     BEGIN
      select @errno  = 30002,
             @errmsg = 'Impossível Incluir #VENDAS_LOTE# porque #TOT_QTDE_ORIGINAL# do pedido é menor que mínimo permitido (300pç) para esta #CONDIÇÃO DE PAGAMENTO#'
      goto error
     END     

	 ---- Verifica TOT_QTDE_ORIGINAL x CONDIÇÃO DE PAGAMENTO
  --   if (@condicaoPgto = 'AL' AND @qtde_pecas < 500)
  --   BEGIN
  --    select @errno  = 30002,
  --           @errmsg = 'Impossível Incluir #VENDAS_LOTE# porque #TOT_QTDE_ORIGINAL# do pedido é menor que mínimo permitido (500pç) para esta #CONDIÇÃO DE PAGAMENTO#'
  --    goto error
  --   END     

  END
  /* Fim */  

/* insert de registros para controle de CÓPIA DE PEDIDO REPRESENTANTE  VENDAS_LOTE                     */

    INSERT INTO VENDAS_LOTE_COPIA_PEDIDO (PEDIDO_EXTERNO,TIPO_DO_DIGITADOR,MOEDA,CODIGO_TAB_PRECO
           ,TIPO,CONDICAO_PGTO,COLECAO,CLIENTE_ATACADO,REPRESENTANTE,PEDIDO,EMISSAO
           ,DATA_ENVIO,DATA_RECEBIMENTO,PEDIDO_CLIENTE,DESCONTO,ENCARGO,TOT_QTDE_ORIGINAL
           ,TOT_VALOR_ORIGINAL,VALOR_IPI,CTRL_MULT_ENTREGAS,ENTREGA_CIF,ENTREGA_ACEITAVEL
           ,DESCONTO_SOBRE_1,DESCONTO_SOBRE_2,DESCONTO_SOBRE_3,DESCONTO_SOBRE_4,OBS
           ,FILIAL,TRANSPORTADORA,GERENTE,APROVACAO,APROVADO_POR,CONFERIDO,CONFERIDO_POR
           ,COMISSAO,COMISSAO_GERENTE,PORCENTAGEM_ACERTO,PRIORIDADE,ACEITA_JUNTAR_PED
           ,STATUS,DATA_PARA_TRANSFERENCIA,TIPO_FRETE,TABELA_FILHA,MULTI_DESCONTO_ACUMULAR
           ,RECARGO,ACEITA_PECAS_PEQUENAS,ACEITA_PECAS_COM_CORTE,FRETE_CORTESIA,DATA_FATURAMENTO_RELATIVO
           ,INDICA_LOCAL_SEPARACAO,EXPEDICAO_PORCENTAGEM_MAIOR,EXPEDICAO_PORCENTAGEM_MINIMA,EXPEDICAO_PORCENTAGEM_TIPO
           ,EXPEDICAO_COMPLETO_PEDIDO,EXPEDICAO_COMPLETO_PACK,EXPEDICAO_COMPLETO_TAMANHOS
           ,EXPEDICAO_COMPLETO_COR,EXPEDICAO_COMPLETO_COORDENADO,EXPEDICAO_COMPLETO_CARTELA
           ,TIPO_CAIXA,PERIODO_PCP,NOME_CLIFOR_ENTREGA,EXPEDICAO_NAO_JUNTAR_PRODUTO_CAIXA
           ,OBS_TRANSPORTE,TIPO_RATEIO,NUMERO_ENTREGA,TRANSP_REDESPACHO,PEDIDO_EXTERNO_ORIGEM
           ,FILIAL_DIGITACAO,PORC_DESCONTO,NATUREZA_SAIDA,COMISSAO_VALOR_GERENTE,COMISSAO_VALOR
           ,PORC_DESCONTO_COND_PGTO,DESCONTO_COND_PGTO,PORC_ENCARGO)
    SELECT  VENDAS_LOTE.PEDIDO_EXTERNO,VENDAS_LOTE.TIPO_DO_DIGITADOR,VENDAS_LOTE.MOEDA,VENDAS_LOTE.CODIGO_TAB_PRECO
           ,VENDAS_LOTE.TIPO,VENDAS_LOTE.CONDICAO_PGTO,VENDAS_LOTE.COLECAO,VENDAS_LOTE.CLIENTE_ATACADO,VENDAS_LOTE.REPRESENTANTE,VENDAS_LOTE.PEDIDO,VENDAS_LOTE.EMISSAO
           ,VENDAS_LOTE.DATA_ENVIO,VENDAS_LOTE.DATA_RECEBIMENTO,VENDAS_LOTE.PEDIDO_CLIENTE,VENDAS_LOTE.DESCONTO,VENDAS_LOTE.ENCARGO,VENDAS_LOTE.TOT_QTDE_ORIGINAL
           ,VENDAS_LOTE.TOT_VALOR_ORIGINAL,VENDAS_LOTE.VALOR_IPI,VENDAS_LOTE.CTRL_MULT_ENTREGAS,VENDAS_LOTE.ENTREGA_CIF,VENDAS_LOTE.ENTREGA_ACEITAVEL
           ,VENDAS_LOTE.DESCONTO_SOBRE_1,VENDAS_LOTE.DESCONTO_SOBRE_2,VENDAS_LOTE.DESCONTO_SOBRE_3,VENDAS_LOTE.DESCONTO_SOBRE_4,VENDAS_LOTE.OBS
           ,VENDAS_LOTE.FILIAL,VENDAS_LOTE.TRANSPORTADORA,VENDAS_LOTE.GERENTE,VENDAS_LOTE.APROVACAO,VENDAS_LOTE.APROVADO_POR,VENDAS_LOTE.CONFERIDO,VENDAS_LOTE.CONFERIDO_POR
           ,VENDAS_LOTE.COMISSAO,VENDAS_LOTE.COMISSAO_GERENTE,VENDAS_LOTE.PORCENTAGEM_ACERTO,VENDAS_LOTE.PRIORIDADE,VENDAS_LOTE.ACEITA_JUNTAR_PED
           ,VENDAS_LOTE.STATUS,VENDAS_LOTE.DATA_PARA_TRANSFERENCIA,VENDAS_LOTE.TIPO_FRETE,VENDAS_LOTE.TABELA_FILHA,VENDAS_LOTE.MULTI_DESCONTO_ACUMULAR
           ,VENDAS_LOTE.RECARGO,VENDAS_LOTE.ACEITA_PECAS_PEQUENAS,VENDAS_LOTE.ACEITA_PECAS_COM_CORTE,VENDAS_LOTE.FRETE_CORTESIA,VENDAS_LOTE.DATA_FATURAMENTO_RELATIVO
           ,VENDAS_LOTE.INDICA_LOCAL_SEPARACAO,VENDAS_LOTE.EXPEDICAO_PORCENTAGEM_MAIOR,VENDAS_LOTE.EXPEDICAO_PORCENTAGEM_MINIMA,VENDAS_LOTE.EXPEDICAO_PORCENTAGEM_TIPO
           ,VENDAS_LOTE.EXPEDICAO_COMPLETO_PEDIDO,VENDAS_LOTE.EXPEDICAO_COMPLETO_PACK,VENDAS_LOTE.EXPEDICAO_COMPLETO_TAMANHOS
           ,VENDAS_LOTE.EXPEDICAO_COMPLETO_COR,VENDAS_LOTE.EXPEDICAO_COMPLETO_COORDENADO,VENDAS_LOTE.EXPEDICAO_COMPLETO_CARTELA
           ,VENDAS_LOTE.TIPO_CAIXA,VENDAS_LOTE.PERIODO_PCP,VENDAS_LOTE.NOME_CLIFOR_ENTREGA,VENDAS_LOTE.EXPEDICAO_NAO_JUNTAR_PRODUTO_CAIXA
           ,VENDAS_LOTE.OBS_TRANSPORTE,VENDAS_LOTE.TIPO_RATEIO,VENDAS_LOTE.NUMERO_ENTREGA,VENDAS_LOTE.TRANSP_REDESPACHO,VENDAS_LOTE.PEDIDO_EXTERNO_ORIGEM
           ,VENDAS_LOTE.FILIAL_DIGITACAO,VENDAS_LOTE.PORC_DESCONTO,VENDAS_LOTE.NATUREZA_SAIDA,VENDAS_LOTE.COMISSAO_VALOR_GERENTE,VENDAS_LOTE.COMISSAO_VALOR
           ,VENDAS_LOTE.PORC_DESCONTO_COND_PGTO,VENDAS_LOTE.DESCONTO_COND_PGTO,VENDAS_LOTE.PORC_ENCARGO
    FROM VENDAS_LOTE,INSERTED
    WHERE VENDAS_LOTE.PEDIDO_EXTERNO=INSERTED.PEDIDO_EXTERNO

/*-----------------------------------------------------------------------------------------------------*/
    --- SOLICITAÇÃO DO COMERCIAL ( EDUARDO MAIA ) EM 11/08/2016
    UPDATE VENDAS_LOTE SET VENDAS_LOTE.NATUREZA_SAIDA='100.01'
    FROM VENDAS_LOTE,inserted
    WHERE VENDAS_LOTE.PEDIDO_EXTERNO = inserted.PEDIDO_EXTERNO
/*-----------------------------------------------------------------------------------------------------*/

  return
error:
    raiserror @errno @errmsg
    rollback transaction
end


